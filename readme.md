# ã€Šredisæ·±åº¦å†é™©ã€‹å­¦ä¹ ç¬”è®°

## redisåŸºç¡€çŸ¥è¯†ï¼ŒåŒ…å«å¸¸è§å‘½ä»¤
- å¸¸ç”¨é’ˆå¯¹keyçš„å‘½ä»¤
>å‘½ä»¤
>>DEL keyï¼šè¯¥å‘½ä»¤ç”¨äºåœ¨ key å­˜åœ¨æ—¶åˆ é™¤ key
>>EXISTS keyï¼šæ£€æŸ¥ç»™å®š key æ˜¯å¦å­˜åœ¨
>>EXPIRE key secondsï¼šä¸ºç»™å®š key è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä»¥ç§’è®¡
>>PEXPIRE key millisecondsï¼šè®¾ç½® key çš„è¿‡æœŸæ—¶é—´ä»¥æ¯«ç§’è®¡
>>KEYS patternï¼šæŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆç»™å®šæ¨¡å¼( pattern)çš„ key
>>PTTL keyï¼šä»¥æ¯«ç§’ä¸ºå•ä½è¿”å› key çš„å‰©ä½™çš„è¿‡æœŸæ—¶é—´
>>TTL key ï¼šä»¥ç§’ä¸ºå•ä½ï¼Œè¿”å›ç»™å®š key çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´(TTL, time to live)
>>
>>DUMP keyï¼šåºåˆ—åŒ–ç»™å®š key ï¼Œå¹¶è¿”å›è¢«åºåˆ—åŒ–çš„å€¼
>>EXPIREAT key timestampï¼šEXPIREAT çš„ä½œç”¨å’Œ EXPIRE ç±»ä¼¼ï¼Œéƒ½ç”¨äºä¸º key è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚ ä¸åŒåœ¨äº EXPIREAT å‘½ä»¤æ¥å—çš„æ—¶é—´å‚æ•°æ˜¯ UNIX æ—¶é—´æˆ³(unix timestamp)
>>PEXPIREAT key milliseconds-timestamp ï¼šè®¾ç½® key è¿‡æœŸæ—¶é—´çš„æ—¶é—´æˆ³(unix timestamp) ä»¥æ¯«ç§’è®¡
>>MOVE key dbï¼šå°†å½“å‰æ•°æ®åº“çš„ key ç§»åŠ¨åˆ°ç»™å®šçš„æ•°æ®åº“ db å½“ä¸­
>>PERSIST key ï¼šç§»é™¤ key çš„è¿‡æœŸæ—¶é—´ï¼Œkey å°†æŒä¹…ä¿æŒ
>>RANDOMKEYï¼šä»å½“å‰æ•°æ®åº“ä¸­éšæœºè¿”å›ä¸€ä¸ª key
>>RENAME key newkey ï¼šä¿®æ”¹ key çš„åç§°
>>RENAMENX key newkey ï¼šä»…å½“ newkey ä¸å­˜åœ¨æ—¶ï¼Œå°† key æ”¹åä¸º newkey 
>>TYPE key ï¼šè¿”å› key æ‰€å‚¨å­˜çš„å€¼çš„ç±»å‹

### redisäº”ç§æ•°æ®ç»“æ„
- string
> å‘½ä»¤ï¼š
>>SET key valueï¼šè®¾ç½®æŒ‡å®š key çš„å€¼
>>GET keyï¼šè·å–æŒ‡å®š key çš„å€¼
>>GETSET key valueï¼šå°†ç»™å®š key çš„å€¼è®¾ä¸º value ï¼Œå¹¶è¿”å› key çš„æ—§å€¼(old value)
>>MGET key1 [key2..]ï¼šè·å–æ‰€æœ‰(ä¸€ä¸ªæˆ–å¤šä¸ª)ç»™å®š key çš„å€¼
>>SETEX key seconds valueï¼šå°†å€¼ value å…³è”åˆ° key ï¼Œå¹¶å°† key çš„è¿‡æœŸæ—¶é—´è®¾ä¸º seconds (ä»¥ç§’ä¸ºå•ä½)
>>SETNX key valueï¼šåªæœ‰åœ¨ key ä¸å­˜åœ¨æ—¶è®¾ç½® key çš„å€¼
>>STRLEN keyï¼šè¿”å› key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼çš„é•¿åº¦
>>MSET key value [key value ...]ï¼šåŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ª key-value å¯¹
>>MSETNX key value [key value ...]ï¼šåŒæ—¶è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ª key-value å¯¹ï¼Œå½“ä¸”ä»…å½“æ‰€æœ‰ç»™å®š key éƒ½ä¸å­˜åœ¨
>>INCR keyï¼šå°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å¢ä¸€
>>INCRBY key incrementï¼šå°† key æ‰€å‚¨å­˜çš„å€¼åŠ ä¸Šç»™å®šçš„å¢é‡å€¼ï¼ˆincrementï¼‰
>>DECR keyï¼šå°† key ä¸­å‚¨å­˜çš„æ•°å­—å€¼å‡ä¸€
>>DECRBY key decrementï¼šæ‰€å‚¨å­˜çš„å€¼å‡å»ç»™å®šçš„å‡é‡å€¼ï¼ˆdecrementï¼‰
>>
>>GETRANGE key start endï¼šè¿”å› key ä¸­å­—ç¬¦ä¸²å€¼çš„å­å­—ç¬¦
>>GETBIT key offsetï¼šå¯¹ key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè·å–æŒ‡å®šåç§»é‡ä¸Šçš„ä½(bit)
>>SETBIT key offset valueï¼šå¯¹ key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè®¾ç½®æˆ–æ¸…é™¤æŒ‡å®šåç§»é‡ä¸Šçš„ä½(bit)
>>SETRANGE key offset valueï¼šç”¨ value å‚æ•°è¦†å†™ç»™å®š key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œä»åç§»é‡ offset å¼€å§‹
>>PSETEX key milliseconds valueï¼šè¿™ä¸ªå‘½ä»¤å’Œ SETEX å‘½ä»¤ç›¸ä¼¼ï¼Œä½†å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½® key çš„ç”Ÿå­˜æ—¶é—´ï¼Œè€Œä¸æ˜¯åƒ SETEX å‘½ä»¤é‚£æ ·ï¼Œä»¥ç§’ä¸ºå•ä½
>>INCRBYFLOAT key incrementï¼šå°† key æ‰€å‚¨å­˜çš„å€¼åŠ ä¸Šç»™å®šçš„æµ®ç‚¹å¢é‡å€¼ï¼ˆincrementï¼‰
>>APPEND key valueï¼šå¦‚æœ key å·²ç»å­˜åœ¨å¹¶ä¸”æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ APPEND å‘½ä»¤å°†æŒ‡å®šçš„ value è¿½åŠ åˆ°è¯¥ key åŸæ¥å€¼ï¼ˆvalueï¼‰çš„æœ«å°¾

- list æ˜¯åº•å±‚æ˜¯é“¾è¡¨ç»“æ„ï¼Œç±»ä¼¼äºLinkedListï¼Œå¯ä»¥å®ç°å³è¿›å·¦å‡ºæˆ–å³è¿›å³å‡ºï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—å’Œé“¾è¡¨æ•°æ®ç»“æ„ï¼›
rediså†…éƒ¨å®é™…ä¸Šå¹¶ä¸æ˜¯ä½¿ç”¨çº¯ç²¹çš„é“¾è¡¨ç»“æ„æ¥å®ç°ï¼Œè€Œæ˜¯ä¸€ç§å«åšquickListçš„ä¸€ä¸ªç»“æ„ï¼šé¦–å…ˆåœ¨å…ƒç´ è¾ƒå°‘çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œè¿™ä¸ªç»“æ„ç§°ä¸ºzipListï¼Œä¹Ÿå°±æ˜¯å‹ç¼©åˆ—è¡¨ã€‚
å½“æ•°æ®é‡è¾ƒå¤šæ—¶ï¼Œä¼šæ”¹æˆquickListï¼Œå°†å¤šä¸ªzipListä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²èµ·æ¥ä½¿ç”¨ï¼Œè¿™æ ·æ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œåˆä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™ã€‚
>å‘½ä»¤ï¼š
>>BLPOP key1 [key2 ] timeoutï¼šç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢
>>BRPOP key1 [key2 ] timeoutï¼šç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œ å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢
>>LINDEX key index ï¼šé€šè¿‡ç´¢å¼•è·å–åˆ—è¡¨ä¸­çš„å…ƒç´ 
>>LLEN keyï¼šè·å–åˆ—è¡¨é•¿åº¦
>>LPOP key ï¼šç§»å‡ºå¹¶è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
>>LPUSH key value1 [value2] ï¼šå°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨
>>
>>BRPOPLPUSH source destination timeoutï¼šä»åˆ—è¡¨ä¸­å¼¹å‡ºä¸€ä¸ªå€¼ï¼Œå°†å¼¹å‡ºçš„å…ƒç´ æ’å…¥åˆ°å¦å¤–ä¸€ä¸ªåˆ—è¡¨ä¸­å¹¶è¿”å›å®ƒï¼› å¦‚æœåˆ—è¡¨æ²¡æœ‰å…ƒç´ ä¼šé˜»å¡åˆ—è¡¨ç›´åˆ°ç­‰å¾…è¶…æ—¶æˆ–å‘ç°å¯å¼¹å‡ºå…ƒç´ ä¸ºæ­¢
>>LINSERT key BEFORE|AFTER pivot value ï¼šåœ¨åˆ—è¡¨çš„å…ƒç´ å‰æˆ–è€…åæ’å…¥å…ƒç´ 
>>LPUSHX key valueï¼šå°†ä¸€ä¸ªå€¼æ’å…¥åˆ°å·²å­˜åœ¨çš„åˆ—è¡¨å¤´éƒ¨
>>LRANGE key start stop ï¼šè·å–åˆ—è¡¨æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ 
>>LREM key count valueï¼šç§»é™¤åˆ—è¡¨å…ƒç´ 
>>LSET key index valueï¼šé€šè¿‡ç´¢å¼•è®¾ç½®åˆ—è¡¨å…ƒç´ çš„å€¼
>>LTRIM key start stopï¼šå¯¹ä¸€ä¸ªåˆ—è¡¨è¿›è¡Œä¿®å‰ª(trim)ï¼Œå°±æ˜¯è¯´ï¼Œè®©åˆ—è¡¨åªä¿ç•™æŒ‡å®šåŒºé—´å†…çš„å…ƒç´ ï¼Œä¸åœ¨æŒ‡å®šåŒºé—´ä¹‹å†…çš„å…ƒç´ éƒ½å°†è¢«åˆ é™¤
>>RPOP keyï¼šç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œè¿”å›å€¼ä¸ºç§»é™¤çš„å…ƒç´ 
>>RPOPLPUSH source destinationï¼šç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ æ·»åŠ åˆ°å¦ä¸€ä¸ªåˆ—è¡¨å¹¶è¿”å›
>>RPUSH key value1 [value2]ï¼šåœ¨åˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå€¼
>> RPUSHX key valueï¼šä¸ºå·²å­˜åœ¨çš„åˆ—è¡¨æ·»åŠ å€¼

- hashï¼Œredisçš„hashå’Œjavaçš„hashMapç±»ä¼¼ï¼Œéƒ½æ˜¯æ•°ç»„+é“¾è¡¨äºŒç»´ç»“æ„ï¼Œä¸è¿‡redisçš„hashçš„valueåªèƒ½æ˜¯å­—ç¬¦ä¸²ï¼›
ä¸”rehashæ“ä½œä¹Ÿä¸åŒï¼Œjavaçš„rehashæ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨rehashï¼Œå¤§æ•°æ®é‡ä¸‹éå¸¸è€—æ—¶ï¼Œredisçš„rehashæ˜¯æ¸è¿›å¼hashï¼Œåœ¨hashçš„åŒæ—¶ä¼šä¿ç•™æ–°æ—§ä¸¤ä¸ªhashç»“æ„ï¼Œ
æŸ¥è¯¢æ—¶ä¹Ÿä¼šåŒæ—¶æŸ¥è¯¢ä¸¤ä¸ªhashç»“æ„ï¼Œåœ¨ååºçš„å®šæ—¶ä»»åŠ¡ä¸­å¾ªåºæ¸è¿›çš„å°†æ—§hashçš„å†…å®¹ä¸€ç‚¹ç‚¹è¿ç§»åˆ°æ–°hashä¸­ã€‚
>å‘½ä»¤
>>HDEL key field1 [field2]ï¼šåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå“ˆå¸Œè¡¨å­—æ®µ
>>HEXISTS key fieldï¼šæŸ¥çœ‹å“ˆå¸Œè¡¨ key ä¸­ï¼ŒæŒ‡å®šçš„å­—æ®µæ˜¯å¦å­˜åœ¨
>>HGET key fieldï¼šè·å–å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®šå­—æ®µçš„å€¼
>>HGETALL keyï¼šè·å–åœ¨å“ˆå¸Œè¡¨ä¸­æŒ‡å®š key çš„æ‰€æœ‰å­—æ®µå’Œå€¼
>>HINCRBY key field incrementï¼šä¸ºå“ˆå¸Œè¡¨ key ä¸­çš„æŒ‡å®šå­—æ®µçš„æ•´æ•°å€¼åŠ ä¸Šå¢é‡ increment
>>HINCRBYFLOAT key field incrementï¼šä¸ºå“ˆå¸Œè¡¨ key ä¸­çš„æŒ‡å®šå­—æ®µçš„æµ®ç‚¹æ•°å€¼åŠ ä¸Šå¢é‡ increment 
>>HKEYS keyï¼šè·å–æ‰€æœ‰å“ˆå¸Œè¡¨ä¸­çš„å­—æ®µ
>>HLEN keyï¼šè·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡
>>HMGET key field1 [field2]ï¼šè·å–æ‰€æœ‰ç»™å®šå­—æ®µçš„å€¼
>>HMSET key field1 value1 [field2 value2 ]ï¼šåŒæ—¶å°†å¤šä¸ª field-value (åŸŸ-å€¼)å¯¹è®¾ç½®åˆ°å“ˆå¸Œè¡¨ key ä¸­
>>HSET key field valueï¼šå°†å“ˆå¸Œè¡¨ key ä¸­çš„å­—æ®µ field çš„å€¼è®¾ä¸º value
>>HSETNX key field valueï¼šåªæœ‰åœ¨å­—æ®µ field ä¸å­˜åœ¨æ—¶ï¼Œè®¾ç½®å“ˆå¸Œè¡¨å­—æ®µçš„å€¼
>>HVALS keyï¼šè·å–å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰å€¼
>>HSCAN key cursor [MATCH pattern] [COUNT count]ï¼šè¿­ä»£å“ˆå¸Œè¡¨ä¸­çš„é”®å€¼å¯¹

- set,ç›¸å½“äºjavaä¸­çš„hashSet
>å‘½ä»¤
>>SADD key member1 [member2]ï¼šå‘é›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜
>>SCARD keyï¼šè·å–é›†åˆçš„æˆå‘˜æ•°
>>SDIFF key1 [key2]ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†
>>SDIFFSTORE destination key1 [key2]ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„å·®é›†å¹¶å­˜å‚¨åœ¨ destination ä¸­
>>SINTER key1 [key2]ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›†
>>SINTERSTORE destination key1 [key2]ï¼šè¿”å›ç»™å®šæ‰€æœ‰é›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åœ¨ destination ä¸­
>>SISMEMBER key memberï¼šåˆ¤æ–­ member å…ƒç´ æ˜¯å¦æ˜¯é›†åˆ key çš„æˆå‘˜
>>SMEMBERS keyï¼šè¿”å›é›†åˆä¸­çš„æ‰€æœ‰æˆå‘˜
>>SMOVE source destination memberï¼šå°† member å…ƒç´ ä» source é›†åˆç§»åŠ¨åˆ° destination é›†åˆ
>>SPOP keyï¼šç§»é™¤å¹¶è¿”å›é›†åˆä¸­çš„ä¸€ä¸ªéšæœºå…ƒç´ 
>>SRANDMEMBER key [count]ï¼šè¿”å›é›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªéšæœºæ•°
>>SREM key member1 [member2]ï¼šç§»é™¤é›†åˆä¸­ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜
>>SUNION key1 [key2]ï¼šè¿”å›æ‰€æœ‰ç»™å®šé›†åˆçš„å¹¶é›†
>>SUNIONSTORE destination key1 [key2]ï¼šæ‰€æœ‰ç»™å®šé›†åˆçš„å¹¶é›†å­˜å‚¨åœ¨ destination é›†åˆä¸­
>>SSCAN key cursor [MATCH pattern] [COUNT count]ï¼šè¿­ä»£é›†åˆä¸­çš„å…ƒç´ 

- zset æœ‰åºåˆ—è¡¨ï¼Œç±»ä¼¼äºjavaçš„SortedSetå’ŒHashMapçš„ç»“åˆä½“ï¼Œä¸€æ–¹é¢æ˜¯ä¸€ä¸ªsetï¼Œä¿è¯äº†å†…éƒ¨valueçš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢å®ƒå¯ä»¥ç»™æ¯ä¸ªvalueèµ‹äºˆä¸€ä¸ªscoreï¼Œä»£è¡¨äº†è¿™ä¸ªvalueçš„æ’åºæƒé‡ï¼Œ
å†…éƒ¨å®ç°æ˜¯ç”¨ä¸€ç§ã€è·³è·ƒé“¾è¡¨ã€‘çš„æ•°æ®ç»“æ„
>å‘½ä»¤
>>ZADD key score1 member1 [score2 member2]ï¼šå‘æœ‰åºé›†åˆæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ï¼Œæˆ–è€…æ›´æ–°å·²å­˜åœ¨æˆå‘˜çš„åˆ†æ•°
>>ZCARD keyï¼šè·å–æœ‰åºé›†åˆçš„æˆå‘˜æ•°
>>ZCOUNT key min maxï¼šè®¡ç®—åœ¨æœ‰åºé›†åˆä¸­æŒ‡å®šåŒºé—´åˆ†æ•°çš„æˆå‘˜æ•°
>>ZINCRBY key increment memberï¼šæœ‰åºé›†åˆä¸­å¯¹æŒ‡å®šæˆå‘˜çš„åˆ†æ•°åŠ ä¸Šå¢é‡ increment
>>ZINTERSTORE destination numkeys key [key ...]ï¼šè®¡ç®—ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰åºé›†çš„äº¤é›†å¹¶å°†ç»“æœé›†å­˜å‚¨åœ¨æ–°çš„æœ‰åºé›†åˆ key ä¸­
>>ZLEXCOUNT key min maxï¼šåœ¨æœ‰åºé›†åˆä¸­è®¡ç®—æŒ‡å®šå­—å…¸åŒºé—´å†…æˆå‘˜æ•°é‡
>>ZRANGE key start stop [WITHSCORES]ï¼šé€šè¿‡ç´¢å¼•åŒºé—´è¿”å›æœ‰åºé›†åˆæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜
>>ZRANGEBYLEX key min max [LIMIT offset count]ï¼šé€šè¿‡å­—å…¸åŒºé—´è¿”å›æœ‰åºé›†åˆçš„æˆå‘˜
>>ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT]ï¼šé€šè¿‡åˆ†æ•°è¿”å›æœ‰åºé›†åˆæŒ‡å®šåŒºé—´å†…çš„æˆå‘˜
>>ZRANK key memberï¼šè¿”å›æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜çš„ç´¢å¼•
>>ZREM key member [member ...]ï¼šç§»é™¤æœ‰åºé›†åˆä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜
>>ZREMRANGEBYLEX key min maxï¼šç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„å­—å…¸åŒºé—´çš„æ‰€æœ‰æˆå‘˜
>>ZREMRANGEBYRANK key start stopï¼šç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„æ’ååŒºé—´çš„æ‰€æœ‰æˆå‘˜
>>ZREMRANGEBYSCORE key min maxï¼šç§»é™¤æœ‰åºé›†åˆä¸­ç»™å®šçš„åˆ†æ•°åŒºé—´çš„æ‰€æœ‰æˆå‘˜
>>ZREVRANGE key start stop [WITHSCORES]ï¼šè¿”å›æœ‰åºé›†ä¸­æŒ‡å®šåŒºé—´å†…çš„æˆå‘˜ï¼Œé€šè¿‡ç´¢å¼•ï¼Œåˆ†æ•°ä»é«˜åˆ°ä½
>>ZREVRANGEBYSCORE key max min [WITHSCORES]ï¼šè¿”å›æœ‰åºé›†ä¸­æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æˆå‘˜ï¼Œåˆ†æ•°ä»é«˜åˆ°ä½æ’åº
>>ZREVRANK key memberï¼šè¿”å›æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜çš„æ’åï¼Œæœ‰åºé›†æˆå‘˜æŒ‰åˆ†æ•°å€¼é€’å‡(ä»å¤§åˆ°å°)æ’åº
>>ZSCORE key memberï¼šè¿”å›æœ‰åºé›†ä¸­ï¼Œæˆå‘˜çš„åˆ†æ•°å€¼
>>ZUNIONSTORE destination numkeys key [key ...]ï¼šè®¡ç®—ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªæœ‰åºé›†çš„å¹¶é›†ï¼Œå¹¶å­˜å‚¨åœ¨æ–°çš„ key ä¸­
>>ZSCAN key cursor [MATCH pattern] [COUNT count]ï¼šè¿­ä»£æœ‰åºé›†åˆä¸­çš„å…ƒç´ ï¼ˆåŒ…æ‹¬å…ƒç´ æˆå‘˜å’Œå…ƒç´ åˆ†å€¼ï¼‰

### rediså‘å¸ƒè®¢é˜…
>>PSUBSCRIBE pattern [pattern ...]ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªç¬¦åˆç»™å®šæ¨¡å¼çš„é¢‘é“
>>PUBSUB subcommand [argument [argument ...]]ï¼šæŸ¥çœ‹è®¢é˜…ä¸å‘å¸ƒç³»ç»ŸçŠ¶æ€
>>PUBLISH channel messageï¼šå°†ä¿¡æ¯å‘é€åˆ°æŒ‡å®šçš„é¢‘é“
>>PUNSUBSCRIBE [pattern [pattern ...]]ï¼šé€€è®¢æ‰€æœ‰ç»™å®šæ¨¡å¼çš„é¢‘é“
>>SUBSCRIBE channel [channel ...]ï¼šè®¢é˜…ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“çš„ä¿¡æ¯
>>UNSUBSCRIBE [channel [channel ...]]ï¼šæŒ‡é€€è®¢ç»™å®šçš„é¢‘é“

### redisäº‹åŠ¡
- Redis äº‹åŠ¡å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œ å¹¶ä¸”å¸¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªé‡è¦çš„ä¿è¯ï¼š
1.æ‰¹é‡æ“ä½œåœ¨å‘é€ EXEC å‘½ä»¤å‰è¢«æ”¾å…¥é˜Ÿåˆ—ç¼“å­˜ï¼›
2.æ”¶åˆ° EXEC å‘½ä»¤åè¿›å…¥äº‹åŠ¡æ‰§è¡Œï¼Œäº‹åŠ¡ä¸­ä»»æ„å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä½™çš„å‘½ä»¤ä¾ç„¶è¢«æ‰§è¡Œï¼›
3.åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ï¼Œå…¶ä»–å®¢æˆ·ç«¯æäº¤çš„å‘½ä»¤è¯·æ±‚ä¸ä¼šæ’å…¥åˆ°äº‹åŠ¡æ‰§è¡Œå‘½ä»¤åºåˆ—ä¸­
>å‘½ä»¤ï¼š
>>DISCARDï¼šå–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤
>>EXECï¼šæ‰§è¡Œæ‰€æœ‰äº‹åŠ¡å—å†…çš„å‘½ä»¤
>>MULTIï¼šæ ‡è®°ä¸€ä¸ªäº‹åŠ¡å—çš„å¼€å§‹
>>UNWATCHï¼šå–æ¶ˆ WATCH å‘½ä»¤å¯¹æ‰€æœ‰ key çš„ç›‘è§†
>>WATCH key [key ...]ï¼šç›‘è§†ä¸€ä¸ª(æˆ–å¤šä¸ª) key ï¼Œå¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ª(æˆ–è¿™äº›) key è¢«å…¶ä»–å‘½ä»¤æ‰€æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­

## åº”ç”¨ï¼šåƒå¸†ç«å‘-åˆ†å¸ƒå¼é”
- é€šå¸¸ä½¿ç”¨set key value ex è¿‡æœŸæ—¶é—´ nxï¼Œå¦‚set flag true ex 5 nxï¼Œè¯¥æ“ä½œæ˜¯redisæä¾›çš„ä¸€ä¸ªåŸå­æ€§æ“ä½œã€‚
- redisæ— æ³•è§£å†³æŒæœ‰é”çš„çº¿ç¨‹ä¸šåŠ¡é€»è¾‘è¿‡é•¿å¯¼è‡´é”å¤±æ•ˆé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ— æ³•è§£å†³é”çš„ç»­ç§Ÿé—®é¢˜ï¼Œè¯¥é—®é¢˜åœ¨etcdä¸­èƒ½å¤Ÿè§£å†³ï¼Œå¹¶ä¸”redisåˆ†å¸ƒå¼é”æ˜¯APæ¨¡å‹ï¼Œ
è€Œå®é™…ä¸Šåˆ†å¸ƒå¼é”éœ€è¦è§£å†³çš„ä¸šåŠ¡åœºæ™¯æ˜¯CPåœºæ™¯ï¼Œæ‰€ä»¥ä¸€èˆ¬æç«¯æƒ…å†µä¸‹æ— æ³•æ»¡è¶³åˆ†å¸ƒå¼é”çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨zookeeperæˆ–è€…etcdæ¥å®ç°åˆ†å¸ƒå¼é”ã€‚

## åº”ç”¨ï¼šç¼“å…µä¹‹è®¡-å»¶è¿Ÿé˜Ÿåˆ—
- ä½¿ç”¨redisçš„listå®ç°é˜Ÿåˆ—æ¶ˆæ¯ï¼Œä½¿ç”¨blpop/brpopæ¥æ¶ˆè´¹é˜Ÿåˆ—ä¸­æ¶ˆæ¯ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯åˆ™ä¼šç¡çœ 

## åº”ç”¨ï¼šèŠ‚è¡£ç¼©é£Ÿ-ä½å›¾
- ä¸»è¦èƒ½å¤ŸèŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œä½¿ç”¨biteå­˜å‚¨æ•°æ®

## åº”ç”¨ï¼šå››ä¸¤æ‹¨åƒæ–¤-HyperLogLog
- redisæä¾›çš„HyperLogLogè¿™ç§æ•°æ®ç±»å‹æ˜¯ç”¨æ¥è§£å†³ç±»ä¼¼äºUVè¿™ç§ç»Ÿè®¡é—®é¢˜ï¼Œæä¾›äº†ä¸ç²¾ç¡®çš„å»é‡è®¡æ•°æ–¹æ¡ˆï¼Œæ ‡å‡†è¯¯å·®åœ¨0.81%ã€‚
>ä¸šåŠ¡åœºæ™¯å¦‚ä¸‹ï¼šä¸€ä¸ªæœ‰å¤§é‡ç”¨æˆ·çš„å¹³å°éœ€è¦è®¿é—®æ¯ä¸€ä¸ªé¡µé¢æ¯å¤©æœ‰å¤šå°‘ç”¨æˆ·è®¿é—®ï¼Œå³UVï¼›è§£å†³æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ¡ˆï¼Œå³åœ¨redisä¸­æ¯ä¸€ä¸ªé¡µé¢å­˜æ”¾ä¸€ä¸ªsetï¼Œ
>redisçš„keyæ˜¯è¿™ä¸ªé¡µé¢çš„æ ‡è¯†ï¼Œsetä¸­æ˜¯è®¿é—®çš„ç”¨æˆ·idï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡éƒ½å°†è®¿é—®çš„ç”¨æˆ·idæ·»åŠ ï¼ˆsaddï¼‰åˆ°setä¸­ï¼Œæœ€åç»Ÿè®¡ä¸€ä¸‹æ•°é‡ï¼ˆscardï¼‰ä¸€ä¸‹å³å¯ï¼Œä½†æ˜¯è¿™æ ·
>å½“å­˜åœ¨å¤§é‡ç”¨æˆ·æ—¶ä¼šå¯¼è‡´redisä¸­æ¯ä¸ªé¡µé¢çš„setä¸­å­˜æ”¾ç€å¤§é‡çš„ç”¨æˆ·idï¼Œå ç”¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œä½†æ˜¯å®é™…ä¸Šåªæ˜¯ä¸ºäº†ç»Ÿè®¡æ•°é‡ã€‚
>å¯ä»¥ä½¿ç”¨è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨HyperLogLogæ¥å­˜å‚¨;æ¯ä¸ªTyperLogLogå æ®12kçš„å­˜å‚¨ç©ºé—´ï¼ŒæŸäº›åœºæ™¯ä¸‹å°±ä¸åˆé€‚ï¼Œå¦‚æ¯ä¸ªç”¨æˆ·ä¸€å¤©çš„è®¿é—®æ¬¡æ•°ï¼Œå¦‚æœç”¨æˆ·çš„æ•°é‡åœ¨ç™¾ä¸‡ç”šè‡³åƒä¸‡ä»¥ä¸Šï¼Œé‚£ä¹ˆå°±ä¸åˆé€‚ï¼Œ
>å®é™…ä¸ŠHyperLogLogæ¯”è¾ƒé€‚åˆä¸ç²¾ç¡®ç»Ÿè®¡ï¼Œå¹¶ä¸”keyçš„æ•°é‡æ¯”è¾ƒå°‘çš„æƒ…å†µï¼Œå¦‚æ¯ä¸ªé¡µé¢ç»Ÿè®¡ï¼Œä¸€ä¸ªç½‘ç«™çš„é¡µé¢æœ€å¤šä¹Ÿå°±ä¸Šç™¾ä¸Šåƒä¸ªï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·ä¸ºkeyå°±ä¸åˆé€‚äº†ï¼Œå¾ˆå¤šç½‘ç«™ç”¨æˆ·ä¸€èˆ¬éƒ½ä¸Šåä¸‡ç”šè‡³æ›´å¤šã€‚
>å‘½ä»¤ï¼š
>>pfadd key value :å¢åŠ 
>>pfcount key valueï¼šç»Ÿè®¡æ•°é‡

## åº”ç”¨ï¼šå±‚å³¦å å¶‚-å¸ƒéš†è¿‡æ»¤å™¨
- å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸“é—¨ç”¨æ¥è§£å†³å»é‡é—®é¢˜ï¼Œä¸æ˜¯å®Œå…¨ç²¾ç¡®ï¼Œä½†æ˜¯å®ƒå ç”¨ç©ºé—´éå¸¸å°ï¼Œä¸€èˆ¬èŠ‚çœ90%å·¦å³çš„ç©ºé—´ã€‚è¯¥æ•°æ®ç»“æ„å¯ä»¥ç†è§£æˆæ˜¯ä¸€ä¸ªä¸é‚£ä¹ˆç²¾ç¡®çš„setã€‚
- å½“å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå€¼å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¸å­˜åœ¨ï¼›å½“å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå€¼ä¸å­˜åœ¨æ˜¯ï¼Œè¯¥å€¼è‚¯å®šä¸å­˜åœ¨ã€‚
- æ³¨æ„å¸ƒéš†è¿‡æ»¤å™¨åœ¨åŸå§‹redisä¸­æ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦å•ç‹¬ä¸‹è½½å¹¶ä¸€æ’ä»¶çš„å½¢å¼åŠ è½½åˆ°redisä¸­å¯åŠ¨ï¼Œå…·ä½“è¯¦æƒ…å¯ä»¥ç™¾åº¦
>å‘½ä»¤
>>bf.addï¼šæ·»åŠ å…ƒç´ 
>>bf.existsï¼šåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨
>>bf.maddï¼šæ‰¹é‡æ·»åŠ å…ƒç´ 
>>bf.mexistsï¼šæ‰¹é‡åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨
- å¸ƒéš†è¿‡æ»¤å™¨åŸç†--äº†è§£ä¸€ä¸‹ï¼Œä¸»è¦èƒ½å¤ŸèŠ‚çœæ¯”è¾ƒå¤§é‡çš„ç©ºé—´ï¼Œå¯ä»¥æ˜¾è‘—çš„é™ä½æ•°æ®åº“çš„IOè¯·æ±‚æ•°é‡

## åº”ç”¨ï¼šçŸ­å°¾æ±‚ç”Ÿ-ç®€å•é™æµ
- ä¸ºäº†æ§åˆ¶æµé‡ï¼Œé™æµçš„ä¸€ä¸ªç›®çš„æ˜¯æ§åˆ¶è¯·æ±‚ï¼Œé˜²æ­¢å¤§é‡è¯·æ±‚æŠŠç³»ç»Ÿå‹å®ï¼›å¦å¤–ä¸€ä¸ªç›®çš„æ˜¯æ§åˆ¶ç”¨æˆ·è¡Œä¸ºã€‚
- åœºæ™¯ï¼šç³»ç»Ÿè¦é™åˆ¶æŸä¸ªç”¨æˆ·çš„æŸä¸ªåŠ¨ä½œåœ¨æŸä¸ªæ—¶é—´èŒƒå›´å†…åªå…è®¸æ“ä½œNæ¬¡ï¼Œå¦‚ä¸€ä¸ªç”¨æˆ·ä¸€åˆ†é’Ÿåªèƒ½å¤Ÿå›å¤5ä¸ªå¸–å­
- è§£å†³æ–¹æ¡ˆï¼šè¿™ä¸ªé™æµéœ€æ±‚ä¸­å­˜åœ¨ç€ä¸€ä¸ªæ»‘åŠ¨æ—¶é—´çª—å£ï¼Œåªç”¨zsetæ•°æ®ç»“æ„çš„scoreå€¼åœˆå‡ºè¿™ä¸ªæ—¶é—´çª—å£ï¼Œåªéœ€è¦ä¿ç•™æ—¶é—´çª—å£ä¹‹å†…çš„å€¼ï¼Œæ—¶é—´çª—å£ä¹‹å¤–çš„ä¸ç”¨ä¿å­˜ã€‚
- ä¸€ä¸ªzsetç»“æ„è®°å½•ç”¨æˆ·çš„è¡Œä¸ºå†å²ï¼Œæ¯ä¸€ä¸ªè¡Œä¸ºéƒ½ä¼šä½œä¸ºzsetä¸­çš„ä¸€ä¸ªkeyä¿å­˜ä¸‹æ¥ã€‚åŒä¸€ä¸ªç”¨æˆ·åŒä¸€ç§è¡Œä¸ºç”¨ä¸€ä¸ªzsetè®°å½•ã€‚é€šè¿‡ç»Ÿè®¡æ»‘åŠ¨çª—å£çš„è¡Œä¸ºæ•°é‡ä¸é˜ˆå€¼max_countè¿›è¡Œæ¯”è¾ƒ
å°±å¯ä»¥å¾—å‡ºå½“å‰è¡Œä¸ºæ˜¯å¦å…è®¸ã€‚

## é€šç”¨çŸ¥è¯†ç‚¹
- å½“å‡ºç°æ‰¹é‡æ‰§è¡Œå‘½ä»¤çš„æƒ…å†µä¸‹ï¼Œå»ºè®®ä½¿ç”¨redisçš„ç®¡é“ï¼špipelineæŠ€æœ¯æ‰¹é‡æ‰§è¡Œå‘½ä»¤ï¼Œå¤§å¤§ç¼©çŸ­æ‰§è¡Œå‘½ä»¤çš„æ—¶é—´ï¼Œåœ¨åä¸‡çº§ä»¥ä¸Šæµ‹è¯•æ—¶æ—¶é—´å·®è·åœ¨50å€å·¦å³ï¼Œå¿…è¦æƒ…å†µä¸‹å¯ä»¥åˆ†å¤šæ¬¡æ‰§è¡Œpipelineï¼Œå¦‚æ¯æ¬¡æ‰§è¡Œåä¸‡

## åº”ç”¨ï¼šä¸€æ¯›ä¸æ‹”-æ¼æ–—é™æµ
- æ¼æ–—çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæ¼æ–—çš„å‰©ä½™ç©ºé—´å°±ä»£è¡¨å½“å‰è¡Œä¸ºå¯ä»¥æŒç»­è¿›è¡Œçš„æ•°é‡ï¼Œæ¼æ–—çš„æµæ°´é€Ÿç‡ä»£è¡¨ç€ç³»ç»Ÿå…è®¸è¯¥è¡Œä¸ºçš„æœ€å¤§é¢‘ç‡ã€‚
- redis 4.0å¯ä»¥ä½¿ç”¨redis-cellæ¨¡å—å®ç°æ¼æ–—ç®—æ³•ï¼š
cl.throttle KEY capacity(æ¼æ–—çš„å®¹é‡ï¼Œå¦‚30) operations(èƒ½å¤Ÿæ“ä½œçš„æ¬¡æ•°ï¼Œå¦‚30) seconds(è¡¨ç¤ºæ—¶é—´å‘¨æœŸ) quota(é»˜è®¤æ˜¯1ï¼Œå³ä¸€ä¸ªä¸€ä¸ªæµåŠ¨)

## åº”ç”¨ï¼šè¿›æ°´æ¥¼å°-GeoHash
- redis 3.2ç‰ˆæœ¬å¢åŠ åœ°ç†ä½ç½®GEOæ¨¡å—ï¼Œèƒ½å¤Ÿå®ç°é™„è¿‘çš„é¤é¦†ä¹‹ç±»çš„åŠŸèƒ½
- è®¡ç®—é™„è¿‘çš„ç‚¹çš„åšæ³•ä¸šå†…ä¸€èˆ¬ä½¿ç”¨GeoHashç®—æ³•ã€‚GeoHashç®—æ³•æ˜¯å°†äºŒç»´çš„ç»çº¬åº¦æ•°æ®æ˜ å°„åˆ°ä¸€ç»´çš„æ•´æ•°ï¼Œè¿™æ ·æ‰€æœ‰çš„å…ƒç´ éƒ½å°†åœ¨æŒ‚è½½åˆ°ä¸€æ¡çº¿ä¸Šï¼Œ
è·ç¦»é è¿‘çš„äºŒç»´åæ ‡æ˜ å°„åˆ°ä¸€ç»´åçš„ç‚¹ä¹‹é—´çš„è·ç¦»ä¹Ÿä¼šå¾ˆæ¥è¿‘
åœ¨ä½¿ç”¨Redisè¿›è¡ŒGeoæŸ¥è¯¢æ—¶ï¼Œå®ƒçš„å†…éƒ¨ç»“æ„å®é™…ä¸Šåªæ˜¯ä¸€ä¸ªzset(skiplist)ã€‚é€šè¿‡zsetçš„scoreæ’åºå°±å¯ä»¥å¾—åˆ°åæ ‡é™„è¿‘çš„å…¶ä»–å…ƒç´ ï¼Œé€šè¿‡å°†score
è¿˜åŸæˆåæ ‡å€¼å°±å¯ä»¥å¾—åˆ°å…ƒç´ çš„åŸå§‹åæ ‡ã€‚
>å‘½ä»¤
>>geoadd keyName ç»åº¦ çº¬åº¦ keyValueï¼šæ–°å¢ä¸€ä¸ªç‚¹ä½,å¦‚ï¼š
>>>geoadd company 116.48105 39.996794 juejin
>>>geoadd company 116.514203 39.905409 ireader
>>>geoadd company 116.489033 40.007669 meituan
>>>geoadd company 116.562108 39.787602 jd 116.334255 40.027400 xiaomi

>>geolist keyName keyValue1 keyValue2 å•ä½ï¼šm/km/ml/ftï¼šæŸ¥è¯¢ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œå¦‚ï¼š
>>>geodist company juejin ireader km
>>>geodist company juejin jd km

>>geopos keyName keyValueï¼šè·å–ç‚¹ä½çš„ç»çº¬åº¦ï¼Œå¦‚ï¼š
>>>geopos company juejin

>>geohash keyName keyValueï¼šè·å–å…ƒç´ ç»çº¬åº¦ç¼–ç å­—ç¬¦ä¸²ï¼Œä½¿ç”¨http://geohash.org/${hash}ä¸­ç›´æ¥å®šä½ï¼Œå¦‚ï¼š
>>>geohash company juejin

>>georadiusbymember keyName keyValue è·ç¦» è·ç¦»å•ä½ count æ•°é‡ æ­£åºæˆ–é™åºï¼Œå¦‚ï¼šgeoradiusbymember companyï¼Œå¦‚ï¼š
>>>georadiusbymember company ireader 20 km count 3 ascï¼šèŒƒå›´ 20 å…¬é‡Œä»¥å†…æœ€å¤š 3 ä¸ªå…ƒç´ æŒ‰è·ç¦»æ­£æ’ï¼Œå®ƒä¸ä¼šæ’é™¤è‡ªèº«
>>>georadiusbymember company ireader 20 km count 3 desc:èŒƒå›´ 20 å…¬é‡Œä»¥å†…æœ€å¤š 3 ä¸ªå…ƒç´ æŒ‰è·ç¦»å€’æ’
>>ä¸‰ä¸ªå¯é€‰å‚æ•° withcoord withdist withhash ç”¨æ¥æºå¸¦é™„åŠ å‚æ•°,withdist å¾ˆæœ‰ç”¨ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ˜¾ç¤ºè·ç¦»,å¦‚
>>> georadiusbymember company ireader 20 km withcoord withdist withhash count 3 asc

>>redisè¿˜æä¾›æ ¹æ®ç»çº¬åº¦æŸ¥è¯¢é™„è¿‘çš„å…ƒç´ ï¼Œå…·ä½“å‚æ•°ä¸georadiusbymemberç›¸åŒï¼Œåªéœ€è¦å°†å‘½ä»¤æ”¹ä¸ºgeoradiusï¼Œå°†keyValueæ”¹æˆç»çº¬åº¦å³å¯ï¼Œå¦‚ï¼š
>>>georadius company 116.514202 39.905409 20 km withdist count 3 asc

>æ³¨æ„äº‹é¡¹ï¼š
>>åœ¨ä¸€ä¸ªåœ°å›¾åº”ç”¨ä¸­ï¼Œè½¦çš„æ•°æ®ã€é¤é¦†çš„æ•°æ®ã€äººçš„æ•°æ®å¯èƒ½ä¼šæœ‰ç™¾ä¸‡åƒä¸‡æ¡ï¼Œå¦‚æœä½¿ç”¨Redis çš„ Geo æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å°†å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ª zset é›†åˆä¸­ã€‚
>>åœ¨ Redis çš„é›†ç¾¤ç¯å¢ƒä¸­ï¼Œé›†åˆå¯èƒ½ä¼šä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå•ä¸ª key çš„æ•°æ®è¿‡å¤§ï¼Œä¼šå¯¹é›†ç¾¤çš„è¿ç§»å·¥ä½œé€ æˆè¾ƒå¤§çš„å½±å“ï¼Œ
>>åœ¨é›†ç¾¤ç¯å¢ƒä¸­å•ä¸ª key å¯¹åº”çš„æ•°æ®é‡ä¸å®œè¶…è¿‡ 1Mï¼Œå¦åˆ™ä¼šå¯¼è‡´é›†ç¾¤è¿ç§»å‡ºç°å¡é¡¿ç°è±¡ï¼Œå½±å“çº¿ä¸ŠæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚
>>æ‰€ä»¥ï¼Œè¿™é‡Œå»ºè®® Geo çš„æ•°æ®ä½¿ç”¨å•ç‹¬çš„ Redis å®ä¾‹éƒ¨ç½²ï¼Œä¸ä½¿ç”¨é›†ç¾¤ç¯å¢ƒã€‚
>>å¦‚æœæ•°æ®é‡è¿‡äº¿ç”šè‡³æ›´å¤§ï¼Œå°±éœ€è¦å¯¹ Geo æ•°æ®è¿›è¡Œæ‹†åˆ†ï¼ŒæŒ‰å›½å®¶æ‹†åˆ†ã€æŒ‰çœæ‹†åˆ†ï¼ŒæŒ‰
>>å¸‚æ‹†åˆ†ï¼Œåœ¨äººå£ç‰¹å¤§åŸå¸‚ç”šè‡³å¯ä»¥æŒ‰åŒºæ‹†åˆ†ã€‚è¿™æ ·å°±å¯ä»¥æ˜¾è‘—é™ä½å•ä¸ª zset é›†åˆçš„å¤§å°ã€‚

## åº”ç”¨ï¼šå¤§æµ·æé’ˆ-Scan
- redisæä¾›keys pattenæ¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢æŒ‡å®šçš„keyï¼Œä½†æ˜¯è¯¥æ–¹å¼æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š
1.æ²¡æœ‰ offsetã€ limit å‚æ•°ï¼Œ ä¸€æ¬¡æ€§åå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ keyï¼Œ ä¸‡ä¸€å®ä¾‹ä¸­æœ‰å‡ ç™¾ w ä¸ªkey æ»¡è¶³æ¡ä»¶ï¼Œ å½“ä½ çœ‹åˆ°æ»¡å±çš„å­—ç¬¦ä¸²åˆ·çš„æ²¡æœ‰å°½å¤´æ—¶ï¼Œ ä½ å°±çŸ¥é“éš¾å—äº†ã€‚
2.keys ç®—æ³•æ˜¯éå†ç®—æ³•ï¼Œ å¤æ‚åº¦æ˜¯ O(n)ï¼Œ å¦‚æœå®ä¾‹ä¸­æœ‰åƒä¸‡çº§ä»¥ä¸Šçš„ keyï¼Œ è¿™ä¸ªæŒ‡ä»¤å°±ä¼šå¯¼è‡´ Redis æœåŠ¡å¡é¡¿ï¼Œ æ‰€æœ‰è¯»å†™ Redis çš„å…¶å®ƒçš„æŒ‡ä»¤éƒ½ä¼šè¢«å»¶åç”šè‡³ä¼šè¶…æ—¶æŠ¥é”™ï¼Œ 
å› ä¸ºRedis æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œ é¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œ å…¶å®ƒæŒ‡ä»¤å¿…é¡»ç­‰åˆ°å½“å‰çš„ keys æŒ‡ä»¤æ‰§è¡Œå®Œäº†æ‰å¯ä»¥ç»§ç»­ã€‚
- ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œredisåœ¨2.8ç‰ˆæœ¬ä¸­æä¾›äº†scanï¼Œscançš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š
1.å¤æ‚åº¦è™½ç„¶ä¹Ÿæ˜¯ O(n)ï¼Œ ä½†æ˜¯å®ƒæ˜¯é€šè¿‡æ¸¸æ ‡åˆ†æ­¥è¿›è¡Œçš„ï¼Œ ä¸ä¼šé˜»å¡çº¿ç¨‹;
2.æä¾› limit å‚æ•°ï¼Œ å¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›ç»“æœçš„æœ€å¤§æ¡æ•°ï¼Œ limit åªæ˜¯ä¸€ä¸ª hintï¼Œ è¿”å›çš„ç»“æœå¯å¤šå¯å°‘(limitä¸æ˜¯é™å®šè¿”å›ç»“æœçš„æ•°é‡ï¼Œè€Œæ˜¯é™å®šæœåŠ¡å™¨å•è¯éå†çš„å­—å…¸æ§½ä½æ•°é‡);
3.åŒ keys ä¸€æ ·ï¼Œ å®ƒä¹Ÿæä¾›æ¨¡å¼åŒ¹é…åŠŸèƒ½;
4.æœåŠ¡å™¨ä¸éœ€è¦ä¸ºæ¸¸æ ‡ä¿å­˜çŠ¶æ€ï¼Œ æ¸¸æ ‡çš„å”¯ä¸€çŠ¶æ€å°±æ˜¯ scan è¿”å›ç»™å®¢æˆ·ç«¯çš„æ¸¸æ ‡æ•´æ•°;
5.è¿”å›çš„ç»“æœå¯èƒ½ä¼šæœ‰é‡å¤ï¼Œ éœ€è¦å®¢æˆ·ç«¯å»é‡å¤ï¼Œ è¿™ç‚¹éå¸¸é‡è¦;
6.éå†çš„è¿‡ç¨‹ä¸­å¦‚æœæœ‰æ•°æ®ä¿®æ”¹ï¼Œ æ”¹åŠ¨åçš„æ•°æ®èƒ½ä¸èƒ½éå†åˆ°æ˜¯ä¸ç¡®å®šçš„;
7.å•æ¬¡è¿”å›çš„ç»“æœæ˜¯ç©ºçš„å¹¶ä¸æ„å‘³ç€éå†ç»“æŸï¼Œ è€Œè¦çœ‹è¿”å›çš„æ¸¸æ ‡å€¼æ˜¯å¦ä¸ºé›¶;
>å‘½ä»¤
>>scan cursor match patten count æ•°é‡ï¼Œæœ€å¼€å§‹cursorä¸º0ï¼Œæ¯ä¸€æ¬¡éå†çš„cursorä¸ºä¸Šä¸€æ¬¡éå†è¿”å›çš„cursorï¼Œç›´åˆ°cursorä¸º0åˆ™è¡¨ç¤ºéå†ç»“æŸï¼Œå¦‚ï¼šscan 0 match key99* count 1000

>å­—å…¸çš„ç»“æ„ï¼š
>>åœ¨ Redis ä¸­æ‰€æœ‰çš„ key éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå¾ˆå¤§çš„å­—å…¸ä¸­ï¼Œè¿™ä¸ªå­—å…¸çš„ç»“æ„å’Œ Java ä¸­çš„HashMap ä¸€æ ·ï¼Œæ˜¯ä¸€ç»´æ•°ç»„ + äºŒç»´é“¾è¡¨ç»“æ„ï¼Œç¬¬ä¸€ç»´æ•°ç»„çš„å¤§å°æ€»æ˜¯ 2^n(n>=0)ï¼Œæ‰©å®¹ä¸€
>>æ¬¡æ•°ç»„å¤§å°ç©ºé—´åŠ å€ï¼Œä¹Ÿå°±æ˜¯ n++ã€‚scan æŒ‡ä»¤è¿”å›çš„æ¸¸æ ‡å°±æ˜¯ç¬¬ä¸€ç»´æ•°ç»„çš„ä½ç½®ç´¢å¼•ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä½ç½®ç´¢å¼•ç§°ä¸ºæ§½ (slot)ã€‚å¦‚æœä¸è€ƒè™‘å­—å…¸çš„æ‰©å®¹ç¼©å®¹ï¼Œç›´æ¥æŒ‰æ•°ç»„ä¸‹æ ‡æŒ¨ä¸ªéå†å°±è¡Œäº†ã€‚
>>limit å‚æ•°å°±è¡¨ç¤ºéœ€è¦éå†çš„æ§½ä½æ•°ï¼Œä¹‹æ‰€ä»¥è¿”å›çš„ç»“æœå¯èƒ½å¤šå¯èƒ½å°‘ï¼Œæ˜¯å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„æ§½ä½ä¸Šéƒ½ä¼šæŒ‚æ¥é“¾è¡¨ï¼Œæœ‰äº›æ§½ä½å¯èƒ½æ˜¯ç©ºçš„ï¼Œè¿˜æœ‰äº›æ§½ä½ä¸ŠæŒ‚æ¥çš„é“¾è¡¨ä¸Šçš„å…ƒç´ å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚
>>æ¯ä¸€æ¬¡éå†éƒ½ä¼šå°† limitæ•°é‡çš„æ§½ä½ä¸ŠæŒ‚æ¥çš„æ‰€æœ‰é“¾è¡¨å…ƒç´ è¿›è¡Œæ¨¡å¼åŒ¹é…è¿‡æ»¤åï¼Œä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

>>Java çš„ HashMap åœ¨æ‰©å®¹æ—¶ä¼šä¸€æ¬¡æ€§å°†æ—§æ•°ç»„ä¸‹æŒ‚æ¥çš„å…ƒç´ å…¨éƒ¨è½¬ç§»åˆ°æ–°æ•°ç»„ä¸‹é¢ã€‚å¦‚æœ HashMap ä¸­å…ƒç´ ç‰¹åˆ«å¤šï¼Œçº¿ç¨‹å°±ä¼šå‡ºç°å¡é¡¿ç°è±¡ã€‚ Redis ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒé‡‡ç”¨æ¸
>>è¿›å¼ rehashå®ƒä¼šåŒæ—¶ä¿ç•™æ—§æ•°ç»„å’Œæ–°æ•°ç»„ï¼Œç„¶ååœ¨å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠåç»­å¯¹ hash çš„æŒ‡ä»¤æ“ä½œä¸­æ¸æ¸åœ°å°†æ—§æ•°ç»„ä¸­æŒ‚æ¥çš„å…ƒç´ è¿ç§»åˆ°æ–°æ•°ç»„ä¸Šã€‚è¿™æ„å‘³ç€è¦æ“ä½œå¤„äº rehash ä¸­çš„å­—å…¸ï¼Œ
>éœ€è¦åŒæ—¶è®¿é—®æ–°æ—§ä¸¤ä¸ªæ•°ç»„ç»“æ„ã€‚å¦‚æœåœ¨æ—§æ•°ç»„ä¸‹é¢æ‰¾ä¸åˆ°å…ƒç´ ï¼Œè¿˜éœ€è¦å»æ–°æ•°ç»„ä¸‹é¢å»å¯»æ‰¾ã€‚scan ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå¯¹ä¸ rehash ä¸­çš„å­—å…¸ï¼Œå®ƒéœ€è¦åŒæ—¶æ‰«ææ–°æ—§æ§½ä½ï¼Œç„¶åå°†ç»“æœèåˆåè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

## åŸç†ï¼šé­è¾Ÿå…¥é‡Œ-çº¿ç¨‹IOæ¨¡å‹
- redisæ˜¯ä¸ªå•çº¿ç¨‹ç¨‹åºã€‚
- rediså•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿï¼šå› ä¸ºå®ƒæ‰€æœ‰çš„æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œæ‰€æœ‰çš„è¿ç®—éƒ½æ˜¯å†…å­˜çº§åˆ«çš„è¿ç®—ã€‚æ­£å› ä¸º Redis æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥è¦å°å¿ƒä½¿ç”¨ Redis æŒ‡ä»¤ï¼Œå¯¹äºé‚£äº›æ—¶é—´å¤æ‚åº¦ä¸º O(n) çº§åˆ«çš„æŒ‡ä»¤ï¼Œ
ä¸€å®šè¦è°¨æ…ä½¿ç”¨ï¼Œä¸€ä¸å°å¿ƒå°±å¯èƒ½ä¼šå¯¼è‡´ Redis å¡é¡¿ã€‚
- rediså•çº¿ç¨‹å¦‚ä½•å¤„ç†é‚£ä¹ˆå¤šçš„å¹¶å‘å®¢æˆ·ç«¯é“¾æ¥ï¼Ÿï¼šå¤šè·¯å¤ç”¨ï¼Œselectç³»åˆ—çš„æ—¶é—´è½®è¯¢ï¼Œéé˜»å¡IOã€‚
>éé˜»å¡IO
>>éé˜»å¡ IO åœ¨å¥—æ¥å­—å¯¹è±¡ä¸Šæä¾›äº†ä¸€ä¸ªé€‰é¡¹ Non_Blockingï¼Œå½“è¿™ä¸ªé€‰é¡¹æ‰“å¼€æ—¶ï¼Œè¯»å†™æ–¹æ³•ä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯èƒ½è¯»å¤šå°‘è¯»å¤šå°‘ï¼Œèƒ½å†™å¤šå°‘å†™å¤šå°‘ã€‚èƒ½è¯»å¤šå°‘å–å†³äºå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„
>>è¯»ç¼“å†²åŒºå†…éƒ¨çš„æ•°æ®å­—èŠ‚æ•°ï¼Œèƒ½å†™å¤šå°‘å–å†³äºå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å†™ç¼“å†²åŒºçš„ç©ºé—²ç©ºé—´å­—èŠ‚æ•°ã€‚è¯»æ–¹æ³•å’Œå†™æ–¹æ³•éƒ½ä¼šé€šè¿‡è¿”å›å€¼æ¥å‘ŠçŸ¥ç¨‹åºå®é™…è¯»å†™äº†å¤šå°‘å­—èŠ‚ã€‚
>äº‹ä»¶è½®è¯¢ï¼ˆå¤šè·¯å¤ç”¨ï¼‰
>>æœ€ç®€å•çš„äº‹ä»¶è½®è¯¢ API æ˜¯ select å‡½æ•°ï¼Œå®ƒæ˜¯æ“ä½œç³»ç»Ÿæä¾›ç»™ç”¨æˆ·ç¨‹åºçš„ APIã€‚è¾“å…¥æ˜¯è¯»å†™æè¿°ç¬¦åˆ—è¡¨ read_fds & write_fdsï¼Œè¾“å‡ºæ˜¯ä¸ä¹‹å¯¹åº”çš„å¯è¯»å¯å†™äº‹ä»¶ã€‚
>>åŒæ—¶è¿˜æä¾›äº†ä¸€ä¸ª timeout å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œé‚£ä¹ˆå°±æœ€å¤šç­‰å¾… timeout æ—¶é—´ï¼Œçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ã€‚ä¸€æ—¦æœŸé—´æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œå°±å¯ä»¥ç«‹å³è¿”å›ã€‚æ—¶é—´è¿‡
>>äº†ä¹‹åè¿˜æ˜¯æ²¡æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œä¹Ÿä¼šç«‹å³è¿”å›ã€‚ æ‹¿åˆ°äº‹ä»¶åï¼Œçº¿ç¨‹å°±å¯ä»¥ç»§ç»­æŒ¨ä¸ªå¤„ç†ç›¸åº”çš„äº‹ä»¶ã€‚å¤„ç†å®Œäº†ç»§ç»­è¿‡æ¥è½®è¯¢ã€‚äºæ˜¯çº¿ç¨‹å°±è¿›å…¥äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œ
>>æˆ‘ä»¬æŠŠè¿™ä¸ªæ­»å¾ªç¯ç§°ä¸ºäº‹ä»¶å¾ªç¯ï¼Œä¸€ä¸ªå¾ªç¯ä¸ºä¸€ä¸ªå‘¨æœŸã€‚
```java
/*
ä¼ªä»£ç å¦‚ä¸‹ï¼š
read_events,write_events = select(read_fds,write_fds,timeout)
for event in read_events:
    handle_read(event.fd);
for event in write_events:
    handle_write(event.fd)
handle_others()
*/
```
>>å› ä¸ºæˆ‘ä»¬é€šè¿‡ select ç³»ç»Ÿè°ƒç”¨åŒæ—¶å¤„ç†å¤šä¸ªé€šé“æè¿°ç¬¦çš„è¯»å†™äº‹ä»¶ï¼Œå› æ­¤æˆ‘ä»¬å°†è¿™ç±»ç³»ç»Ÿè°ƒç”¨ç§°ä¸ºå¤šè·¯å¤ç”¨ APIã€‚ç°ä»£æ“ä½œç³»ç»Ÿçš„å¤šè·¯å¤ç”¨ API å·²ç»ä¸å†ä½¿ç”¨ select ç³»ç»Ÿè°ƒç”¨ï¼Œ
>>è€Œæ”¹ç”¨ epoll(linux)å’Œ kqueue(freebsd & macosx)ï¼Œå› ä¸º select ç³»ç»Ÿè°ƒç”¨çš„æ€§èƒ½åœ¨æè¿°ç¬¦ç‰¹åˆ«å¤šæ—¶æ€§èƒ½ä¼šéå¸¸å·®ã€‚
- æŒ‡ä»¤é˜Ÿåˆ—ï¼šRedis ä¼šå°†æ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—éƒ½å…³è”ä¸€ä¸ªæŒ‡ä»¤é˜Ÿåˆ—ã€‚å®¢æˆ·ç«¯çš„æŒ‡ä»¤é€šè¿‡é˜Ÿåˆ—æ¥æ’é˜Ÿè¿›è¡Œé¡ºåºå¤„ç†ï¼Œå…ˆåˆ°å…ˆæœåŠ¡ã€‚
- å“åº”é˜Ÿåˆ—ï¼šRedis åŒæ ·ä¹Ÿä¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—å…³è”ä¸€ä¸ªå“åº”é˜Ÿåˆ—ã€‚ Redis æœåŠ¡å™¨é€šè¿‡å“åº”é˜Ÿåˆ—æ¥å°†æŒ‡ä»¤çš„è¿”å›ç»“æœå›å¤ç»™å®¢æˆ·ç«¯ã€‚ å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œ
é‚£ä¹ˆæ„å‘³ç€è¿æ¥æš‚æ—¶å¤„äºç©ºé—²çŠ¶æ€ï¼Œä¸éœ€è¦å»è·å–å†™äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å°†å½“å‰çš„å®¢æˆ·ç«¯æè¿°ç¬¦ä» write_fds é‡Œé¢ç§»å‡ºæ¥ã€‚ç­‰åˆ°é˜Ÿåˆ—æœ‰æ•°æ®äº†ï¼Œ
å†å°†æè¿°ç¬¦æ”¾è¿›å»ã€‚é¿å… select ç³»ç»Ÿè°ƒç”¨ç«‹å³è¿”å›å†™äº‹ä»¶ï¼Œç»“æœå‘ç°æ²¡ä»€ä¹ˆæ•°æ®å¯ä»¥å†™ã€‚å‡ºè¿™ç§æƒ…å†µçš„çº¿ç¨‹ä¼šé£™é«˜ CPUã€‚
- å®šæ—¶ä»»åŠ¡ï¼šRedis çš„å®šæ—¶ä»»åŠ¡ä¼šè®°å½•åœ¨ä¸€ä¸ªç§°ä¸ºæœ€å°å †çš„æ•°æ®ç»“æ„ä¸­ã€‚è¿™ä¸ªå †ä¸­ï¼Œæœ€å¿«è¦æ‰§è¡Œçš„ä»»åŠ¡æ’åœ¨å †çš„æœ€ä¸Šæ–¹ã€‚åœ¨æ¯ä¸ªå¾ªç¯å‘¨æœŸï¼Œ 
Redis éƒ½ä¼šå°†æœ€å°å †é‡Œé¢å·²ç»åˆ°ç‚¹çš„ä»»åŠ¡ç«‹å³è¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œæ¯•åï¼Œå°†æœ€å¿«è¦æ‰§è¡Œçš„ä»»åŠ¡è¿˜éœ€è¦çš„æ—¶é—´è®°å½•ä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶é—´å°±æ˜¯ select ç³»ç»Ÿè°ƒ
ç”¨çš„ timeout å‚æ•°ã€‚å› ä¸º Redis çŸ¥é“æœªæ¥ timeout æ—¶é—´å†…ï¼Œæ²¡æœ‰å…¶å®ƒå®šæ—¶ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œæ‰€ä»¥å¯ä»¥å®‰å¿ƒç¡çœ  timeout çš„æ—¶é—´ã€‚

## åŸç†ï¼šäº¤å¤´æ¥è€³-é€šä¿¡åè®®
- RESP(Redis Serialization Protocol)ï¼šRESP æ˜¯ Redis åºåˆ—åŒ–åè®®çš„ç®€å†™ã€‚å®ƒæ˜¯ä¸€ç§ç›´è§‚çš„æ–‡æœ¬åè®®ï¼Œä¼˜åŠ¿åœ¨äºå®ç°å¼‚å¸¸ç®€å•ï¼Œè§£ææ€§èƒ½æå¥½ã€‚
>Redis åè®®å°†ä¼ è¾“çš„ç»“æ„æ•°æ®åˆ†ä¸º 5 ç§æœ€å°å•å…ƒç±»å‹ï¼Œå•å…ƒç»“æŸæ—¶ç»Ÿä¸€åŠ ä¸Šå›è½¦æ¢è¡Œç¬¦å·\r\nã€‚
>>1ã€ å•è¡Œå­—ç¬¦ä¸² ä»¥ + ç¬¦å·å¼€å¤´ã€‚
>>2ã€ å¤šè¡Œå­—ç¬¦ä¸² ä»¥ $ ç¬¦å·å¼€å¤´ï¼Œ åè·Ÿå­—ç¬¦ä¸²é•¿åº¦ã€‚
>>3ã€ æ•´æ•°å€¼ ä»¥ : ç¬¦å·å¼€å¤´ï¼Œ åè·Ÿæ•´æ•°çš„å­—ç¬¦ä¸²å½¢å¼ã€‚
>>4ã€ é”™è¯¯æ¶ˆæ¯ ä»¥ - ç¬¦å·å¼€å¤´ã€‚
>>5ã€ æ•°ç»„ ä»¥ * å·å¼€å¤´ï¼Œ åè·Ÿæ•°ç»„çš„é•¿åº¦ã€‚
- å®¢æˆ·ç«¯->æœåŠ¡å™¨ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€çš„æŒ‡ä»¤åªæœ‰ä¸€ç§æ ¼å¼ï¼Œå¤šè¡Œå­—ç¬¦ä¸²æ•°ç»„ï¼›æœåŠ¡å™¨->å®¢æˆ·ç«¯ï¼šå¤šç§æ¶ˆæ¯ç»„åˆ

## åŸç†ï¼šæœªé›¨ç»¸ç¼ª-æŒä¹…åŒ–
- redisçš„æŒä¹…åŒ–æœºåˆ¶æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å¿«ç…§ï¼Œå¦å¤–ä¸€ç§æ˜¯AOFæ—¥å¿—ã€‚
### å¿«ç…§åŸç†
>å¿«ç…§æ˜¯ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œ AOF æ—¥å¿—æ˜¯è¿ç»­çš„å¢é‡å¤‡ä»½ã€‚å¿«ç…§æ˜¯å†…å­˜æ•°æ®çš„äºŒè¿›åˆ¶åºåˆ—åŒ–å½¢å¼ï¼Œåœ¨å­˜å‚¨ä¸Šéå¸¸ç´§å‡‘ï¼Œè€Œ AOF æ—¥å¿—è®°å½•çš„æ˜¯å†…å­˜æ•°æ®ä¿®æ”¹çš„æŒ‡ä»¤è®°å½•æ–‡æœ¬ã€‚ 
>AOF æ—¥å¿—åœ¨é•¿æœŸçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå˜çš„æ— æ¯”åºå¤§ï¼Œæ•°æ®åº“é‡å¯æ—¶éœ€è¦åŠ è½½ AOF æ—¥å¿—è¿›è¡ŒæŒ‡ä»¤é‡æ”¾ï¼Œè¿™ä¸ªæ—¶é—´å°±ä¼šæ— æ¯”æ¼«é•¿ã€‚æ‰€ä»¥éœ€è¦å®šæœŸè¿›è¡Œ AOF é‡å†™ï¼Œç»™ AOF æ—¥å¿—è¿›è¡Œç˜¦èº«.
- rediså¿«ç…§ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹COW(Copy On Write)æœºåˆ¶æ¥å®ç°å¿«ç…§æŒä¹…åŒ–ã€‚
- fork(å¤šè¿›ç¨‹)
>Redis åœ¨æŒä¹…åŒ–æ—¶ä¼šè°ƒç”¨ glibc çš„å‡½æ•° fork äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¿«ç…§æŒä¹…åŒ–å®Œå…¨äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚å­è¿›ç¨‹åˆšåˆšäº§ç”Ÿæ—¶ï¼Œå®ƒå’Œçˆ¶è¿›ç¨‹å…±äº«å†…å­˜é‡Œé¢çš„ä»£
>ç æ®µå’Œæ•°æ®æ®µã€‚è¿™æ—¶ä½ å¯ä»¥å°†çˆ¶å­è¿›ç¨‹æƒ³åƒæˆä¸€ä¸ªè¿ä½“å©´å„¿ï¼Œå…±äº«èº«ä½“ã€‚è¿™æ˜¯ Linux æ“ä½œç³»ç»Ÿçš„æœºåˆ¶ï¼Œä¸ºäº†èŠ‚çº¦å†…å­˜èµ„æºï¼Œæ‰€ä»¥å°½å¯èƒ½è®©å®ƒä»¬å…±äº«èµ·æ¥ã€‚åœ¨è¿›ç¨‹åˆ†ç¦»çš„ä¸€ç¬é—´ï¼Œå†…å­˜çš„
>å¢é•¿å‡ ä¹æ²¡æœ‰æ˜æ˜¾å˜åŒ–ã€‚
> fork å‡½æ•°ä¼šåœ¨çˆ¶å­è¿›ç¨‹åŒæ—¶è¿”å›ï¼Œåœ¨çˆ¶è¿›ç¨‹é‡Œè¿”å›å­è¿›ç¨‹çš„ pidï¼Œåœ¨å­è¿›ç¨‹é‡Œè¿”å›é›¶ã€‚å¦‚æœæ“ä½œç³»ç»Ÿå†…å­˜èµ„æºä¸è¶³ï¼Œ pid å°±ä¼šæ˜¯è´Ÿæ•°ï¼Œè¡¨ç¤º fork å¤±è´¥ã€‚
>å­è¿›ç¨‹åšæ•°æ®æŒä¹…åŒ–ï¼Œå®ƒä¸ä¼šä¿®æ”¹ç°æœ‰çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå®ƒåªæ˜¯å¯¹æ•°æ®ç»“æ„è¿›è¡Œéå†è¯»å–ï¼Œç„¶ååºåˆ—åŒ–å†™åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯çˆ¶è¿›ç¨‹ä¸ä¸€æ ·ï¼Œå®ƒå¿…é¡»æŒç»­æœåŠ¡å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶åå¯¹å†…å­˜
>æ•°æ®ç»“æ„è¿›è¡Œä¸é—´æ–­çš„ä¿®æ”¹ã€‚
>è¿™ä¸ªæ—¶å€™å°±ä¼šä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ COW æœºåˆ¶æ¥è¿›è¡Œæ•°æ®æ®µé¡µé¢çš„åˆ†ç¦»ã€‚æ•°æ®æ®µæ˜¯ç”±å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„é¡µé¢ç»„åˆè€Œæˆï¼Œå½“çˆ¶è¿›ç¨‹å¯¹å…¶ä¸­ä¸€ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šå°†è¢«å…±äº«çš„é¡µé¢å¤
>åˆ¶ä¸€ä»½åˆ†ç¦»å‡ºæ¥ï¼Œç„¶åå¯¹è¿™ä¸ªå¤åˆ¶çš„é¡µé¢è¿›è¡Œä¿®æ”¹ã€‚è¿™æ—¶å­è¿›ç¨‹ç›¸åº”çš„é¡µé¢æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œè¿˜æ˜¯è¿›ç¨‹äº§ç”Ÿæ—¶é‚£ä¸€ç¬é—´çš„æ•°æ®ã€‚
>éšç€çˆ¶è¿›ç¨‹ä¿®æ”¹æ“ä½œçš„æŒç»­è¿›è¡Œï¼Œè¶Šæ¥è¶Šå¤šçš„å…±äº«é¡µé¢è¢«åˆ†ç¦»å‡ºæ¥ï¼Œå†…å­˜å°±ä¼šæŒç»­å¢é•¿ã€‚ä½†æ˜¯ä¹Ÿä¸ä¼šè¶…è¿‡åŸæœ‰æ•°æ®å†…å­˜çš„ 2 å€å¤§å°ã€‚å¦å¤–ä¸€ä¸ª Redis å®ä¾‹é‡Œå†·æ•°æ®å çš„æ¯”ä¾‹å¾€
>å¾€æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šå‡ºç°æ‰€æœ‰çš„é¡µé¢éƒ½ä¼šè¢«åˆ†ç¦»ï¼Œè¢«åˆ†ç¦»çš„å¾€å¾€åªæœ‰å…¶ä¸­ä¸€éƒ¨åˆ†é¡µé¢ã€‚æ¯ä¸ªé¡µé¢çš„å¤§å°åªæœ‰ 4Kï¼Œä¸€ä¸ª Redis å®ä¾‹é‡Œé¢ä¸€èˆ¬éƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡çš„é¡µé¢ã€‚
>å­è¿›ç¨‹å› ä¸ºæ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œå®ƒèƒ½çœ‹åˆ°çš„å†…å­˜é‡Œçš„æ•°æ®åœ¨è¿›ç¨‹äº§ç”Ÿçš„ä¸€ç¬é—´å°±å‡å›ºäº†ï¼Œå†ä¹Ÿä¸ä¼šæ”¹å˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Redis çš„æŒä¹…åŒ–å«ã€Œå¿«ç…§ã€çš„åŸå› ã€‚æ¥ä¸‹æ¥å­è¿›ç¨‹å°±å¯ä»¥éå¸¸å®‰
>å¿ƒçš„éå†æ•°æ®äº†è¿›è¡Œåºåˆ—åŒ–å†™ç£ç›˜äº†ã€‚
### AOFåŸç†
>AOF æ—¥å¿—å­˜å‚¨çš„æ˜¯ Redis æœåŠ¡å™¨çš„é¡ºåºæŒ‡ä»¤åºåˆ—ï¼Œ AOF æ—¥å¿—åªè®°å½•å¯¹å†…å­˜è¿›è¡Œä¿®æ”¹çš„æŒ‡ä»¤è®°å½•ã€‚
>å‡è®¾ AOF æ—¥å¿—è®°å½•äº†è‡ª Redis å®ä¾‹åˆ›å»ºä»¥æ¥æ‰€æœ‰çš„ä¿®æ”¹æ€§æŒ‡ä»¤åºåˆ—ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹ä¸€ä¸ªç©ºçš„ Redis å®ä¾‹é¡ºåºæ‰§è¡Œæ‰€æœ‰çš„æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ã€Œé‡æ”¾ã€ï¼Œæ¥æ¢å¤ Redis å½“å‰å®ä¾‹çš„å†…
>å­˜æ•°æ®ç»“æ„çš„çŠ¶æ€ã€‚
>Redis ä¼šåœ¨æ”¶åˆ°å®¢æˆ·ç«¯ä¿®æ”¹æŒ‡ä»¤åï¼Œå…ˆè¿›è¡Œå‚æ•°æ ¡éªŒï¼Œå¦‚æœæ²¡é—®é¢˜ï¼Œå°±ç«‹å³å°†è¯¥æŒ‡ä»¤æ–‡æœ¬å­˜å‚¨åˆ° AOF æ—¥å¿—ä¸­ï¼Œä¹Ÿå°±æ˜¯å…ˆå­˜åˆ°ç£ç›˜ï¼Œç„¶åå†æ‰§è¡ŒæŒ‡ä»¤ã€‚è¿™æ ·å³ä½¿é‡åˆ°çªå‘å®•æœºï¼Œå·²
>ç»å­˜å‚¨åˆ° AOF æ—¥å¿—çš„æŒ‡ä»¤è¿›è¡Œé‡æ”¾ä¸€ä¸‹å°±å¯ä»¥æ¢å¤åˆ°å®•æœºå‰çš„çŠ¶æ€
>Redis åœ¨é•¿æœŸè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œ AOF çš„æ—¥å¿—ä¼šè¶Šå˜è¶Šé•¿ã€‚å¦‚æœå®ä¾‹å®•æœºé‡å¯ï¼Œé‡æ”¾æ•´ä¸ªAOF æ—¥å¿—ä¼šéå¸¸è€—æ—¶ï¼Œå¯¼è‡´é•¿æ—¶é—´ Redis æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ã€‚æ‰€ä»¥éœ€è¦å¯¹ AOF æ—¥å¿—ç˜¦èº«ã€‚
- AOFé‡å†™
>Redis æä¾›äº† bgrewriteaof æŒ‡ä»¤ç”¨äºå¯¹ AOF æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚å…¶åŸç†å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªå­è¿›ç¨‹å¯¹å†…å­˜è¿›è¡Œéå†è½¬æ¢æˆä¸€ç³»åˆ— Redis çš„æ“ä½œæŒ‡ä»¤ï¼Œåºåˆ—åŒ–åˆ°ä¸€ä¸ªæ–°çš„ AOF æ—¥å¿—æ–‡ä»¶ä¸­ã€‚
>åºåˆ—åŒ–å®Œæ¯•åå†å°†æ“ä½œæœŸé—´å‘ç”Ÿçš„å¢é‡ AOF æ—¥å¿—è¿½åŠ åˆ°è¿™ä¸ªæ–°çš„ AOF æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿½åŠ å®Œæ¯•åå°±ç«‹å³æ›¿ä»£æ—§çš„ AOF æ—¥å¿—æ–‡ä»¶äº†ï¼Œç˜¦èº«å·¥ä½œå°±å®Œæˆäº†ã€‚
- fsync
>AOF æ—¥å¿—æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜åœ¨çš„ï¼Œå½“ç¨‹åºå¯¹ AOF æ—¥å¿—æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†å†…å®¹å†™åˆ°äº†å†…æ ¸ä¸ºæ–‡ä»¶æè¿°ç¬¦åˆ†é…çš„ä¸€ä¸ªå†…å­˜ç¼“å­˜ä¸­ï¼Œç„¶åå†…æ ¸ä¼šå¼‚æ­¥å°†è„æ•°æ®åˆ·å›åˆ°ç£ç›˜çš„ã€‚
>è¿™å°±æ„å‘³ç€å¦‚æœæœºå™¨çªç„¶å®•æœºï¼Œ AOF æ—¥å¿—å†…å®¹å¯èƒ½è¿˜æ²¡æœ‰æ¥å¾—åŠå®Œå…¨åˆ·åˆ°ç£ç›˜ä¸­ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°æ—¥å¿—ä¸¢å¤±ã€‚é‚£è¯¥æ€ä¹ˆåŠï¼Ÿ
>Linux çš„ glibc æä¾›äº† fsync(int fd)å‡½æ•°å¯ä»¥å°†æŒ‡å®šæ–‡ä»¶çš„å†…å®¹å¼ºåˆ¶ä»å†…æ ¸ç¼“å­˜åˆ·åˆ°ç£ç›˜ã€‚åªè¦ Redis è¿›ç¨‹å®æ—¶è°ƒç”¨ fsync å‡½æ•°å°±å¯ä»¥ä¿è¯ aof æ—¥å¿—ä¸ä¸¢å¤±ã€‚ä½†æ˜¯ fsync æ˜¯ä¸€ä¸ª
>ç£ç›˜ IO æ“ä½œï¼Œå®ƒå¾ˆæ…¢ï¼å¦‚æœ Redis æ‰§è¡Œä¸€æ¡æŒ‡ä»¤å°±è¦ fsync ä¸€æ¬¡ï¼Œé‚£ä¹ˆ Redis é«˜æ€§èƒ½çš„åœ°ä½å°±ä¸ä¿äº†ã€‚
>æ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å™¨ä¸­ï¼Œ Redis é€šå¸¸æ˜¯æ¯éš” 1s å·¦å³æ‰§è¡Œä¸€æ¬¡ fsync æ“ä½œï¼Œå‘¨æœŸ 1sæ˜¯å¯ä»¥é…ç½®çš„ã€‚è¿™æ˜¯åœ¨æ•°æ®å®‰å…¨æ€§å’Œæ€§èƒ½ä¹‹é—´åšäº†ä¸€ä¸ªæŠ˜ä¸­ï¼Œåœ¨ä¿æŒé«˜æ€§èƒ½çš„åŒæ—¶ï¼Œå°½å¯èƒ½
>ä½¿å¾—æ•°æ®å°‘ä¸¢å¤±ã€‚
### è¿ç»´
>å¿«ç…§æ˜¯é€šè¿‡å¼€å¯å­è¿›ç¨‹çš„æ–¹å¼è¿›è¡Œçš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—èµ„æºçš„æ“ä½œã€‚
>1ã€ éå†æ•´ä¸ªå†…å­˜ï¼Œå¤§å—å†™ç£ç›˜ä¼šåŠ é‡ç³»ç»Ÿè´Ÿè½½
>2ã€ AOF çš„ fsync æ˜¯ä¸€ä¸ªè€—æ—¶çš„ IO æ“ä½œï¼Œå®ƒä¼šé™ä½ Redis æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿä¼šå¢åŠ ç³»ç»Ÿ IO è´Ÿæ‹…
>æ‰€ä»¥é€šå¸¸ Redis çš„ä¸»èŠ‚ç‚¹æ˜¯ä¸ä¼šè¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼ŒæŒä¹…åŒ–æ“ä½œä¸»è¦åœ¨ä»èŠ‚ç‚¹è¿›è¡Œã€‚ä»èŠ‚ç‚¹æ˜¯å¤‡ä»½èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚çš„å‹åŠ›ï¼Œå®ƒçš„æ“ä½œç³»ç»Ÿèµ„æºå¾€å¾€æ¯”è¾ƒå……æ²›ã€‚
>ä½†æ˜¯å¦‚æœå‡ºç°ç½‘ç»œåˆ†åŒºï¼Œä»èŠ‚ç‚¹é•¿æœŸè¿ä¸ä¸Šä¸»èŠ‚ç‚¹ï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œåˆ†åŒºå‡ºç°çš„æƒ…å†µä¸‹åˆä¸å°å¿ƒä¸»èŠ‚ç‚¹å®•æœºäº†ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¼šä¸¢å¤±ï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒè¦
>åšå¥½å®æ—¶ç›‘æ§å·¥ä½œï¼Œä¿è¯ç½‘ç»œç•…é€šæˆ–è€…èƒ½å¿«é€Ÿä¿®å¤ã€‚å¦å¤–è¿˜åº”è¯¥å†å¢åŠ ä¸€ä¸ªä»èŠ‚ç‚¹ä»¥é™ä½ç½‘ç»œåˆ†åŒºçš„æ¦‚ç‡ï¼Œåªè¦æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹æ•°æ®åŒæ­¥æ­£å¸¸ï¼Œæ•°æ®ä¹Ÿå°±ä¸ä¼šè½»æ˜“ä¸¢å¤±ã€‚

## åŸç†ï¼šé›·å‰é£è¡Œ-ç®¡é“
- redisç®¡é“æ˜¯æ‰¹é‡æ‰§è¡Œrediså‘½ä»¤ï¼Œåªå‘ç”Ÿä¸€æ¬¡ç½‘ç»œäº¤äº’ã€‚å®é™…ä¸Š Redis ç®¡é“(Pipeline) æœ¬èº«å¹¶ä¸æ˜¯ Redis æœåŠ¡å™¨ç›´æ¥æä¾›çš„æŠ€æœ¯ï¼Œ
è¿™ä¸ªæŠ€æœ¯æœ¬è´¨ä¸Šæ˜¯ç”±å®¢æˆ·ç«¯æä¾›çš„ï¼Œè·ŸæœåŠ¡å™¨æ²¡æœ‰ä»€ä¹ˆç›´æ¥çš„å…³ç³»ã€‚ç®¡é“ä¸­æŒ‡ä»¤è¶Šå¤šï¼Œæ•ˆæœè¶Šå¥½ã€‚
- redisè‡ªå¸¦çš„å‹æµ‹å·¥å…·ï¼šredis-benchmark
### æ·±å…¥ç†è§£ç®¡é“æœ¬è´¨
- å®Œæ•´çš„è¯·æ±‚äº¤äº’æµç¨‹ï¼š
>1.å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨ write å°†æ¶ˆæ¯å†™åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†² send bufferã€‚
>2.å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°†å‘é€ç¼“å†²çš„å†…å®¹å‘é€åˆ°ç½‘å¡ï¼Œ ç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ã€Œç½‘é™…è·¯ç”±ã€é€åˆ°æœåŠ¡å™¨çš„ç½‘å¡ã€‚
>3.æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°†ç½‘å¡çš„æ•°æ®æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥æ”¶ç¼“å†² recv buffer
>4.æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨ read ä»æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚
>5.æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨ write å°†å“åº”æ¶ˆæ¯å†™åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†² send bufferã€‚
>6.æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°†å‘é€ç¼“å†²çš„å†…å®¹å‘é€åˆ°ç½‘å¡ï¼Œ ç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ã€Œç½‘é™…è·¯ç”±ã€é€åˆ°å®¢æˆ·ç«¯çš„ç½‘å¡ã€‚
>7.å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°†ç½‘å¡çš„æ•°æ®æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥æ”¶ç¼“å†² recv bufferã€‚
>8.å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨ read ä»æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¶ˆæ¯è¿”å›ç»™ä¸Šå±‚ä¸šåŠ¡é€»è¾‘è¿›è¡Œå¤„ç†ã€‚
>9.ç»“æŸã€‚
### é‡è¦ï¼ï¼ï¼ç½‘ç»œIOè€—æ—¶çš„çœŸæ­£é¢ç›®ä»¥åŠepollçš„æœ¬è´¨ğŸ‘‡
>æˆ‘ä»¬å¼€å§‹ä»¥ä¸º write æ“ä½œæ˜¯è¦ç­‰åˆ°å¯¹æ–¹æ”¶åˆ°æ¶ˆæ¯æ‰ä¼šè¿”å›ï¼Œä½†å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚ writeæ“ä½œåªè´Ÿè´£å°†æ•°æ®å†™åˆ°æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„
>å‘é€ç¼“å†²ç„¶åå°±è¿”å›äº†ã€‚å‰©ä¸‹çš„äº‹äº¤ç»™æ“ä½œç³»ç»Ÿå†…æ ¸å¼‚æ­¥å°†æ•°æ®é€åˆ°ç›®æ ‡æœºå™¨ã€‚ä½†æ˜¯å¦‚æœå‘é€ç¼“å†²æ»¡äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…ç¼“å†²ç©ºå‡ºç©ºé—²ç©ºé—´
>æ¥ï¼Œè¿™ä¸ªå°±æ˜¯å†™æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚
>æˆ‘ä»¬å¼€å§‹ä»¥ä¸º read æ“ä½œæ˜¯ä»ç›®æ ‡æœºå™¨æ‹‰å–æ•°æ®ï¼Œä½†å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚ read æ“ä½œåªè´Ÿè´£å°†æ•°æ®ä»æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¥å°±äº†äº‹äº†ã€‚
>ä½†æ˜¯å¦‚æœç¼“å†²æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…æ•°æ®åˆ°æ¥ï¼Œè¿™ä¸ªå°±æ˜¯è¯»æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚
>æ‰€ä»¥å¯¹äº value = redis.get(key)è¿™æ ·ä¸€ä¸ªç®€å•çš„è¯·æ±‚æ¥è¯´ï¼Œ write æ“ä½œå‡ ä¹æ²¡æœ‰è€—æ—¶ï¼Œç›´æ¥å†™åˆ°å‘é€ç¼“å†²å°±è¿”å›ï¼Œè€Œ read å°±ä¼šæ¯”è¾ƒè€—æ—¶äº†ï¼Œ
>å› ä¸ºå®ƒè¦ç­‰å¾…æ¶ˆæ¯ç»è¿‡ç½‘ç»œè·¯ç”±åˆ°ç›®æ ‡æœºå™¨å¤„ç†åçš„å“åº”æ¶ˆæ¯,å†å›é€åˆ°å½“å‰çš„å†…æ ¸è¯»ç¼“å†²æ‰å¯ä»¥è¿”å›ã€‚è¿™æ‰æ˜¯ä¸€ä¸ªç½‘ç»œæ¥å›çš„çœŸæ­£å¼€é”€ã€‚
>è€Œå¯¹äºç®¡é“æ¥è¯´ï¼Œè¿ç»­çš„ write æ“ä½œæ ¹æœ¬å°±æ²¡æœ‰è€—æ—¶ï¼Œä¹‹åç¬¬ä¸€ä¸ª read æ“ä½œä¼šç­‰å¾…ä¸€ä¸ªç½‘ç»œçš„æ¥å›å¼€é”€ï¼Œç„¶åæ‰€æœ‰çš„å“åº”æ¶ˆæ¯å°±éƒ½å·²ç»å›é€åˆ°å†…æ ¸çš„è¯»ç¼“å†²äº†ï¼Œ
>åç»­çš„ read æ“ä½œç›´æ¥å°±å¯ä»¥ä»ç¼“å†²æ‹¿åˆ°ç»“æœï¼Œç¬é—´å°±è¿”å›äº†ã€‚

## åŸç†ï¼šåŒèˆŸå…±æµ-äº‹åŠ¡
- æ¯ä¸ªäº‹åŠ¡çš„æ“ä½œéƒ½æœ‰ beginã€ commit å’Œ rollbackï¼Œ begin æŒ‡ç¤ºäº‹åŠ¡çš„å¼€å§‹ï¼Œ commit æŒ‡ç¤ºäº‹åŠ¡çš„æäº¤ï¼Œ rollback æŒ‡ç¤ºäº‹åŠ¡çš„å›æ»šã€‚
Redis åœ¨å½¢å¼ä¸Šçœ‹èµ·æ¥ä¹Ÿå·®ä¸å¤šï¼Œåˆ†åˆ«æ˜¯ multi/exec/discardã€‚ multi æŒ‡ç¤ºäº‹åŠ¡çš„å¼€å§‹ï¼Œexec æŒ‡ç¤ºäº‹åŠ¡çš„æ‰§è¡Œï¼Œ discard æŒ‡ç¤ºäº‹åŠ¡çš„ä¸¢å¼ƒã€‚
- æ‰€æœ‰çš„æŒ‡ä»¤åœ¨ exec ä¹‹å‰ä¸æ‰§è¡Œï¼Œè€Œæ˜¯ç¼“å­˜åœ¨æœåŠ¡å™¨çš„ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼ŒæœåŠ¡å™¨ä¸€æ—¦æ”¶åˆ° exec æŒ‡ä»¤ï¼Œæ‰å¼€æ‰§è¡Œæ•´ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œæ¯•
åä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æŒ‡ä»¤çš„è¿è¡Œç»“æœã€‚å› ä¸º Redis çš„å•çº¿ç¨‹ç‰¹æ€§ï¼Œå®ƒä¸ç”¨æ‹…å¿ƒè‡ªå·±åœ¨æ‰§è¡Œé˜Ÿåˆ—çš„æ—¶å€™è¢«å…¶å®ƒæŒ‡ä»¤æ‰“æ…ï¼Œå¯ä»¥ä¿è¯ä»–ä»¬èƒ½å¾—åˆ°çš„ã€ŒåŸå­æ€§ã€æ‰§è¡Œã€‚
- redisçš„äº‹åŠ¡åªæä¾›äº†éš”ç¦»æ€§ï¼Œåœ¨äº‹åŠ¡ä¸­å‘ç”Ÿé”™è¯¯ä¸ä¼šå½±å“å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ­£ç¡®æŒ‡ä»¤çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸å…·å¤‡åŸå­æ€§ã€‚
- discardæ˜¯åœ¨æ‰§è¡Œexecä¹‹å‰æ‰§è¡Œï¼Œä¼šä¸¢å¼ƒæ‰€æœ‰çš„æŒ‡ä»¤ã€‚
- å¯ä»¥ä½¿ç”¨pipelineæ¥æ‰¹é‡æ‰§è¡Œå¤šä¸ªæŒ‡ä»¤ï¼ŒèŠ‚çœç½‘ç»œIOã€‚
- åˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œä¹Ÿå°±æ˜¯ä¸€ç§æ’ä»–é”ã€‚
- **redisæä¾›watchæœºåˆ¶ï¼Œç±»ä¼¼äºä¹è§‚é”ï¼Œå½“æ‰§è¡ŒæŒ‡ä»¤æ—¶å¦‚æœwatchåˆ°å…³å¿ƒçš„æ•°æ®æœ‰æ”¹å˜ï¼Œåˆ™ä¼šæ‰§è¡ŒæŒ‡ä»¤å¤±è´¥ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸**
```java
/*
ä½¿ç”¨watchæœºåˆ¶çš„ä¼ªä»£ç 
while true
    do_watch()
    commands()
    multi()
    send_commands()
    try
        exec()
        break
    except WatchError
        continue
*/
```
```java
package com.ant;

import redis.clients.jedis.Jedis;
import redis.clients.jedis.Response;
import redis.clients.jedis.Transaction;

import java.util.List;
import java.util.concurrent.TimeUnit;

/**
 * redisäº‹åŠ¡demo
 */
public class TransactionDemo {
    public static void main(String[] args) throws Exception{
        Jedis jedis = new Jedis();
        String userId = "ant";
        String key = String.format("account_{}",userId);
        PU.println(key);
        jedis.setnx(key,String.valueOf(6));
        int val = doubleAccount(jedis,key);
        PU.println(val);

    }
    public static int doubleAccount(Jedis jedis,String key)throws Exception{
        while (true){
            jedis.watch(key);
            TimeUnit.SECONDS.sleep(5);
            int value = Integer.parseInt(jedis.get(key));
            value *= 2;
            Transaction transaction = jedis.multi();
            transaction.set(key,String.valueOf(value));
            List<Object> exec = transaction.exec();
            if(exec!=null){
                //æˆåŠŸ
                break;
            }
        }
        return Integer.parseInt(jedis.get(key));
    }
}

```

## åŸç†ï¼šå°é“æ¶ˆæ¯-PubSub
- redisæ”¯æŒçš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä¸æ”¯æŒå¤šæ’­æœºåˆ¶ã€‚
- æ¶ˆæ¯å¤šæ’­ï¼šæ¶ˆæ¯å¤šæ’­å…è®¸ç”Ÿäº§è€…ç”Ÿäº§ä¸€æ¬¡æ¶ˆæ¯ï¼Œä¸­é—´ä»¶è´Ÿè´£å°†æ¶ˆæ¯å¤åˆ¶åˆ°å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç”±ç›¸åº”çš„æ¶ˆè´¹ç»„è¿›è¡Œæ¶ˆè´¹ã€‚å®ƒæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨çš„ä¸€ç§è§£è€¦æ–¹å¼ï¼Œ
ç”¨äºå°†å¤šä¸ªæ¶ˆè´¹ç»„çš„é€»è¾‘è¿›è¡Œæ‹†åˆ†ã€‚æ”¯æŒäº†æ¶ˆæ¯å¤šæ’­ï¼Œå¤šä¸ªæ¶ˆè´¹ç»„çš„é€»è¾‘å°±å¯ä»¥æ”¾åˆ°ä¸åŒçš„å­ç³»ç»Ÿä¸­ã€‚

## åŸç†ï¼šå¼€æºèŠ‚æµ-å°å¯¹è±¡å‹ç¼©
>å¦‚æœ Redis å†…éƒ¨ç®¡ç†çš„é›†åˆæ•°æ®ç»“æ„å¾ˆå°ï¼Œå®ƒä¼šä½¿ç”¨ç´§å‡‘å­˜å‚¨å½¢å¼å‹ç¼©å­˜å‚¨ã€‚
>è¿™å°±å¥½æ¯” HashMap æœ¬æ¥æ˜¯äºŒç»´ç»“æ„ï¼Œä½†æ˜¯å¦‚æœå†…éƒ¨å…ƒç´ æ¯”è¾ƒå°‘ï¼Œä½¿ç”¨äºŒç»´ç»“æ„åè€Œæµªè´¹ç©ºé—´ï¼Œè¿˜ä¸å¦‚ä½¿ç”¨ä¸€ç»´æ•°ç»„è¿›è¡Œå­˜å‚¨ï¼Œéœ€è¦æŸ¥æ‰¾æ—¶ï¼Œå› ä¸ºå…ƒç´ å°‘è¿›è¡Œéå†ä¹Ÿå¾ˆå¿«ï¼Œ
>ç”šè‡³å¯ä»¥æ¯” HashMap æœ¬èº«çš„æŸ¥æ‰¾è¿˜è¦å¿«ã€‚æ¯”å¦‚ä¸‹é¢æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°ç»„æ¥æ¨¡æ‹Ÿ HashMap çš„å¢åˆ æ”¹æ“ä½œã€‚
>Redis çš„ ziplist æ˜¯ä¸€ä¸ªç´§å‡‘çš„å­—èŠ‚æ•°ç»„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªå…ƒç´ ä¹‹é—´éƒ½æ˜¯ç´§æŒ¨ç€çš„ã€‚å¦‚æœå®ƒå­˜å‚¨çš„æ˜¯ hash ç»“æ„ï¼Œé‚£ä¹ˆ key å’Œ value ä¼šä½œä¸ºä¸¤ä¸ª entry ç›¸é‚»å­˜åœ¨ä¸€èµ·ã€‚
>å¦‚æœå®ƒå­˜å‚¨çš„æ˜¯ zsetï¼Œé‚£ä¹ˆ value å’Œ score ä¼šä½œä¸ºä¸¤ä¸ª entry ç›¸é‚»å­˜åœ¨ä¸€èµ·ã€‚
>Redis çš„ intset æ˜¯ä¸€ä¸ªç´§å‡‘çš„æ•´æ•°æ•°ç»„ç»“æ„ï¼Œå®ƒç”¨äºå­˜æ”¾å…ƒç´ éƒ½æ˜¯æ•´æ•°çš„å¹¶ä¸”å…ƒç´ ä¸ªæ•°è¾ƒå°‘çš„ set é›†åˆã€‚
>å¦‚æœæ•´æ•°å¯ä»¥ç”¨ uint16 è¡¨ç¤ºï¼Œé‚£ä¹ˆ intset çš„å…ƒç´ å°±æ˜¯ 16 ä½çš„æ•°ç»„ï¼Œå¦‚æœæ–°åŠ å…¥çš„æ•´æ•°è¶…è¿‡äº† uint16 çš„è¡¨ç¤ºèŒƒå›´ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ uint32 è¡¨ç¤ºï¼Œå¦‚æœæ–°åŠ å…¥çš„å…ƒç´ è¶…è¿‡äº† uint32
>çš„è¡¨ç¤ºèŒƒå›´ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ uint64 è¡¨ç¤ºï¼Œ Redis æ”¯æŒ set é›†åˆåŠ¨æ€ä» uint16 å‡çº§åˆ° uint32ï¼Œå†å‡çº§åˆ° uint64ã€‚
>å¦‚æœ set é‡Œå­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆ sadd ç«‹å³å‡çº§ä¸º hashtable ç»“æ„ã€‚
### å†…å­˜å›æ”¶æœºåˆ¶
>Redis å¹¶ä¸æ€»æ˜¯å¯ä»¥å°†ç©ºé—²å†…å­˜ç«‹å³å½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚
>å¦‚æœå½“å‰ Redis å†…å­˜æœ‰ 10Gï¼Œå½“ä½ åˆ é™¤äº† 1GB çš„ key åï¼Œå†å»è§‚å¯Ÿå†…å­˜ï¼Œä½ ä¼šå‘ç°å†…å­˜å˜åŒ–ä¸ä¼šå¤ªå¤§ã€‚åŸå› æ˜¯æ“ä½œç³»ç»Ÿå›æ”¶å†…å­˜æ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå¦‚æœè¿™ä¸ªé¡µä¸Šåªè¦æœ‰ä¸€ä¸ª key
>è¿˜åœ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±ä¸èƒ½è¢«å›æ”¶ã€‚ Redis è™½ç„¶åˆ é™¤äº† 1GB çš„ keyï¼Œä½†æ˜¯è¿™äº› key åˆ†æ•£åˆ°äº†å¾ˆå¤šé¡µé¢ä¸­ï¼Œæ¯ä¸ªé¡µé¢éƒ½è¿˜æœ‰å…¶å®ƒ key å­˜åœ¨ï¼Œè¿™å°±å¯¼è‡´äº†å†…å­˜ä¸ä¼šç«‹å³è¢«å›æ”¶ã€‚
>ä¸è¿‡ï¼Œå¦‚æœä½ æ‰§è¡Œ flushdbï¼Œç„¶åå†è§‚å¯Ÿå†…å­˜ä¼šå‘ç°å†…å­˜ç¡®å®è¢«å›æ”¶äº†ã€‚åŸå› æ˜¯æ‰€æœ‰çš„key éƒ½å¹²æ‰äº†ï¼Œå¤§éƒ¨åˆ†ä¹‹å‰ä½¿ç”¨çš„é¡µé¢éƒ½å®Œå…¨å¹²å‡€äº†ï¼Œä¼šç«‹å³è¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚
>Redis è™½ç„¶æ— æ³•ä¿è¯ç«‹å³å›æ”¶å·²ç»åˆ é™¤çš„ key çš„å†…å­˜ï¼Œä½†æ˜¯å®ƒä¼šé‡ç”¨é‚£äº›å°šæœªå›æ”¶çš„ç©ºé—²å†…å­˜ã€‚è¿™å°±å¥½æ¯”ç”µå½±é™¢é‡Œè™½ç„¶äººèµ°äº†ï¼Œä½†æ˜¯åº§ä½è¿˜åœ¨ï¼Œä¸‹ä¸€æ³¢è§‚ä¼—æ¥äº†ï¼Œç›´æ¥åå°±è¡Œã€‚è€Œ
>æ“ä½œç³»ç»Ÿå›æ”¶å†…å­˜å°±å¥½æ¯”æŠŠåº§ä½éƒ½ç»™æ¬èµ°äº†ã€‚

## åŸç†ï¼šæœ‰å¤‡æ— æ‚£-ä¸»ä»åŒæ­¥
- CAPåŸç†
>C-Consistentï¼šä¸€è‡´æ€§
>A-Availabilityï¼šå¯ç”¨æ€§
>P-Partition toleranceï¼šåˆ†åŒºå®¹å¿æ€§/åˆ†åŒºå®¹é”™æ€§
>>åˆ†å¸ƒå¼ç³»ç»Ÿçš„èŠ‚ç‚¹å¾€å¾€éƒ½æ˜¯åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šè¿›è¡Œç½‘ç»œéš”ç¦»å¼€çš„ï¼Œè¿™æ„å‘³ç€å¿…ç„¶ä¼šæœ‰ç½‘ç»œæ–­å¼€çš„é£é™©ï¼Œè¿™ä¸ªç½‘ç»œæ–­å¼€çš„åœºæ™¯çš„ä¸“ä¸šè¯æ±‡å«ç€ã€Œ ç½‘ç»œåˆ†åŒºã€ã€‚
>>åœ¨ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼Œä¸¤ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ä¹‹é—´æ— æ³•è¿›è¡Œé€šä¿¡ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œçš„ä¿®æ”¹æ“ä½œå°†æ— æ³•åŒæ­¥åˆ°å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥æ•°æ®çš„ã€Œä¸€è‡´æ€§ã€å°†æ— æ³•æ»¡è¶³ï¼Œ
>>å› ä¸ºä¸¤ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ•°æ®ä¸å†ä¿æŒä¸€è‡´ã€‚é™¤éæˆ‘ä»¬ç‰ºç‰²ã€Œå¯ç”¨æ€§ã€ï¼Œä¹Ÿå°±æ˜¯æš‚åœåˆ†å¸ƒå¼èŠ‚ç‚¹æœåŠ¡ï¼Œåœ¨ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼Œä¸å†æä¾›ä¿®æ”¹æ•°æ®çš„åŠŸèƒ½ï¼Œç›´åˆ°ç½‘ç»œçŠ¶å†µå®Œå…¨æ¢å¤æ­£å¸¸å†ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ã€‚
- ä¸€å¥è¯æ¦‚æ‹¬ CAP åŸç†å°±æ˜¯â€”â€”ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼Œä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¸¤éš¾å…¨ã€‚
- redisæ˜¯APæ¨¡å‹ï¼Œæ‰€ä»¥redisåšåˆ†å¸ƒå¼é”æœ‰é£é™©
>Redis çš„ä¸»ä»æ•°æ®æ˜¯å¼‚æ­¥åŒæ­¥çš„ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼çš„ Redis ç³»ç»Ÿå¹¶ä¸æ»¡è¶³ã€Œ ä¸€è‡´æ€§ã€è¦æ±‚ã€‚
- æœ€ç»ˆä¸€è‡´æ€§ï¼Œredisä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥åŒæ­¥çš„ï¼Œåœ¨ä¸»ä»ç½‘ç»œæ–­å¼€çš„æƒ…å†µä¸‹ï¼Œä¸»èŠ‚ç‚¹ä¾æ—§å¯ä»¥æ­£å¸¸å¯¹å¤–æä¾›ä¿®æ”¹æœåŠ¡ï¼Œæ‰€ä»¥ Redis æ»¡è¶³ã€Œ å¯ç”¨æ€§ã€ã€‚Redis ä¿è¯ã€Œ æœ€ç»ˆä¸€è‡´æ€§ã€.

## é›†ç¾¤ï¼šæä»£æ¡ƒåƒµ-sentinelï¼ˆå“¨å…µï¼‰
>æˆ‘ä»¬å¯ä»¥å°† Redis Sentinel é›†ç¾¤çœ‹æˆæ˜¯ä¸€ä¸ª ZooKeeper é›†ç¾¤ï¼Œå®ƒè´Ÿè´£æŒç»­ç›‘æ§ä¸»ä»èŠ‚ç‚¹çš„å¥åº·ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æ‰æ—¶ï¼Œè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„ä»èŠ‚ç‚¹åˆ‡æ¢ä¸º
>ä¸»èŠ‚ç‚¹ã€‚å®¢æˆ·ç«¯æ¥è¿æ¥é›†ç¾¤æ—¶ï¼Œä¼šé¦–å…ˆè¿æ¥ sentinelï¼Œé€šè¿‡ sentinel æ¥æŸ¥è¯¢ä¸»èŠ‚ç‚¹çš„åœ°å€ï¼Œç„¶åå†å»è¿æ¥ä¸»èŠ‚ç‚¹è¿›è¡Œæ•°æ®äº¤äº’ã€‚å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œ
>å®¢æˆ·ç«¯ä¼šé‡æ–°å‘ sentinel è¦åœ°å€ï¼Œ sentinel ä¼šå°†æœ€æ–°çš„ä¸»èŠ‚ç‚¹åœ°å€å‘Šè¯‰å®¢æˆ·ç«¯ã€‚å¦‚æ­¤åº”ç”¨ç¨‹åºå°†æ— éœ€é‡å¯å³å¯è‡ªåŠ¨å®ŒæˆèŠ‚ç‚¹åˆ‡æ¢ã€‚
- æ¶ˆæ¯ä¸¢å¤±
>Redis ä¸»ä»é‡‡ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œæ„å‘³ç€å½“ä¸»èŠ‚ç‚¹æŒ‚æ‰æ—¶ï¼Œä»èŠ‚ç‚¹å¯èƒ½æ²¡æœ‰æ”¶åˆ°å…¨éƒ¨çš„åŒæ­¥æ¶ˆæ¯ï¼Œè¿™éƒ¨åˆ†æœªåŒæ­¥çš„æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚å¦‚æœä¸»ä»å»¶è¿Ÿç‰¹åˆ«å¤§ï¼Œé‚£ä¹ˆä¸¢å¤±çš„æ•°æ®å°±å¯èƒ½ä¼šç‰¹åˆ«
>å¤šã€‚ Sentinel æ— æ³•ä¿è¯æ¶ˆæ¯å®Œå…¨ä¸ä¸¢å¤±ï¼Œä½†æ˜¯ä¹Ÿå°½å¯èƒ½ä¿è¯æ¶ˆæ¯å°‘ä¸¢å¤±ã€‚å®ƒæœ‰ä¸¤ä¸ªé€‰é¡¹å¯ä»¥é™åˆ¶ä¸»ä»å»¶è¿Ÿè¿‡å¤§ã€‚min-slaves-to-write 1ã€min-slaves-max-lag 10
>ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºä¸»èŠ‚ç‚¹å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹åœ¨è¿›è¡Œæ­£å¸¸å¤åˆ¶ï¼Œå¦åˆ™å°±åœæ­¢å¯¹å¤–å†™æœåŠ¡ï¼Œä¸§å¤±å¯ç”¨æ€§ã€‚ï¼ˆCPï¼Ÿï¼‰ä½•ä¸ºæ­£å¸¸å¤åˆ¶ï¼Œä½•ä¸ºå¼‚å¸¸å¤åˆ¶ï¼Ÿè¿™ä¸ªå°±æ˜¯ç”±ç¬¬äºŒä¸ªå‚æ•°æ§åˆ¶çš„ï¼Œ
>å®ƒçš„å•ä½æ˜¯ç§’ï¼Œè¡¨ç¤ºå¦‚æœ 10s æ²¡æœ‰æ”¶åˆ°ä»èŠ‚ç‚¹çš„åé¦ˆï¼Œå°±æ„å‘³ç€ä»èŠ‚ç‚¹åŒæ­¥ä¸æ­£å¸¸ï¼Œè¦ä¹ˆç½‘ç»œæ–­å¼€äº†ï¼Œè¦ä¹ˆä¸€ç›´æ²¡æœ‰ç»™åé¦ˆã€‚

## é›†ç¾¤ï¼šåˆ†è€Œæ²»ä¹‹-codis
- codisæ˜¯ä¸€ä¸ªredisé›†ç¾¤ä¸­é—´ä»¶ï¼Œèƒ½å¤ŸæŠŠå¤šä¸ªå°çš„rediså®ä¾‹ï¼ˆå¯ä»¥æ˜¯ä¸»ä»ï¼‰ç»¼åˆèµ·æ¥ï¼Œæ˜¯Goè¯­è¨€å¼€å‘ï¼Œä½¿ç”¨redisåè®®ï¼Œæ— çŠ¶æ€çš„ä¸€ä¸ªä¸­é—´ä»¶ï¼Œ
æ”¯æŒåŠ¨æ€å¢åŠ redisï¼ŒcodisåŒæ ·å¯ä»¥åšé›†ç¾¤ã€‚
- codisåˆ†ç‰‡åŸç†ï¼š
>Codis å°†æ‰€æœ‰çš„ key é»˜è®¤åˆ’åˆ†ä¸º 1024 ä¸ªæ§½ä½(slot)ï¼Œå®ƒé¦–å…ˆå¯¹å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„ key è¿›è¡Œ crc32 è¿ç®—è®¡ç®—å“ˆå¸Œå€¼ï¼Œ
å†å°† hash åçš„æ•´æ•°å€¼å¯¹ 1024 è¿™ä¸ªæ•´æ•°è¿›è¡Œå–æ¨¡å¾—åˆ°ä¸€ä¸ªä½™æ•°ï¼Œè¿™ä¸ªä½™æ•°å°±æ˜¯å¯¹åº” key çš„æ§½ä½ã€‚
- codisä¹‹é—´çš„æ§½ä½æ˜ å°„ï¼š
>å¦‚æœ Codis çš„æ§½ä½æ˜ å°„å…³ç³»åªå­˜å‚¨åœ¨å†…å­˜é‡Œï¼Œé‚£ä¹ˆä¸åŒçš„ Codis å®ä¾‹ä¹‹é—´çš„æ§½ä½å…³ç³»å°±æ— æ³•å¾—åˆ°åŒæ­¥ã€‚
æ‰€ä»¥ Codis è¿˜éœ€è¦ä¸€ä¸ªåˆ†å¸ƒå¼é…ç½®å­˜å‚¨æ•°æ®åº“ä¸“é—¨ç”¨æ¥æŒä¹…åŒ–æ§½ä½å…³ç³»ã€‚Codis å¼€å§‹ä½¿ç”¨ ZooKeeperï¼Œåæ¥è¿ etcd ä¹Ÿä¸€å—æ”¯æŒäº†ã€‚
Codis å°†æ§½ä½å…³ç³»å­˜å‚¨åœ¨ zk ä¸­ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ª Dashboard å¯ä»¥ç”¨æ¥è§‚å¯Ÿå’Œä¿®æ”¹æ§½ä½å…³ç³»ï¼Œå½“æ§½ä½å…³ç³»å˜åŒ–æ—¶ï¼Œ 
Codis Proxy ä¼šç›‘å¬åˆ°å˜åŒ–å¹¶é‡æ–°åŒæ­¥æ§½ä½å…³ç³»ï¼Œä»è€Œå®ç°å¤šä¸ªCodis Proxy ä¹‹é—´å…±äº«ç›¸åŒçš„æ§½ä½å…³ç³»é…ç½®ã€‚
- æ‰©å®¹
>åˆšå¼€å§‹ Codis åç«¯åªæœ‰ä¸€ä¸ª Redis å®ä¾‹ï¼Œ 1024 ä¸ªæ§½ä½å…¨éƒ¨æŒ‡å‘åŒä¸€ä¸ª Redisã€‚ç„¶åä¸€ä¸ª Redis å®ä¾‹å†…å­˜ä¸å¤Ÿäº†ï¼Œæ‰€ä»¥åˆåŠ äº†ä¸€ä¸ª Redis å®ä¾‹ã€‚
>è¿™æ—¶å€™éœ€è¦å¯¹æ§½ä½å…³ç³»è¿›è¡Œè°ƒæ•´ï¼Œå°†ä¸€åŠçš„æ§½ä½åˆ’åˆ†åˆ°æ–°çš„èŠ‚ç‚¹ã€‚è¿™æ„å‘³ç€éœ€è¦å¯¹è¿™ä¸€åŠçš„æ§½ä½å¯¹åº”çš„æ‰€æœ‰ key è¿›è¡Œè¿ç§»ï¼Œè¿ç§»åˆ°æ–°çš„ Redis å®ä¾‹ã€‚
>Codis å¯¹ Redis è¿›è¡Œäº†æ”¹é€ ï¼Œå¢åŠ äº† SLOTSSCAN æŒ‡ä»¤ï¼Œå¯ä»¥éå†æŒ‡å®š slot ä¸‹æ‰€æœ‰çš„keyã€‚ Codis é€šè¿‡ SLOTSSCAN æ‰«æå‡ºå¾…è¿ç§»æ§½ä½çš„æ‰€æœ‰çš„ keyï¼Œ
>ç„¶åæŒ¨ä¸ªè¿ç§»æ¯ä¸ª key åˆ°æ–°çš„ Redis èŠ‚ç‚¹ã€‚
>åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œ Codis è¿˜æ˜¯ä¼šæ¥æ”¶åˆ°æ–°çš„è¯·æ±‚æ‰“åœ¨å½“å‰æ­£åœ¨è¿ç§»çš„æ§½ä½ä¸Šï¼ŒCodis æ— æ³•åˆ¤å®šè¿ç§»è¿‡ç¨‹ä¸­çš„ key ç©¶ç«Ÿåœ¨å“ªä¸ªå®ä¾‹ä¸­ï¼Œæ‰€ä»¥å®ƒé‡‡ç”¨äº†å¦
>ä¸€ç§å®Œå…¨ä¸åŒçš„æ€è·¯ã€‚å½“ Codis æ¥æ”¶åˆ°ä½äºæ­£åœ¨è¿ç§»æ§½ä½ä¸­çš„ key åï¼Œä¼šç«‹å³å¼ºåˆ¶å¯¹å½“å‰çš„å•ä¸ª key è¿›è¡Œè¿ç§»ï¼Œè¿ç§»å®Œæˆåï¼Œå†å°†è¯·æ±‚è½¬å‘åˆ°æ–°çš„ Redis å®ä¾‹ã€‚
- è‡ªåŠ¨å‡è¡¡
>Redis æ–°å¢å®ä¾‹ï¼Œæ‰‹å·¥å‡è¡¡ slots å¤ªç¹çï¼Œæ‰€ä»¥ Codis æä¾›äº†è‡ªåŠ¨å‡è¡¡åŠŸèƒ½ã€‚è‡ªåŠ¨å‡è¡¡ä¼šåœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—²çš„æ—¶å€™è§‚å¯Ÿæ¯ä¸ª Redis å®ä¾‹å¯¹åº”çš„ Slots æ•°é‡ï¼Œ
>å¦‚æœä¸å¹³è¡¡ï¼Œå°±ä¼šè‡ªåŠ¨è¿›è¡Œè¿ç§»ã€‚
- codisçš„ä»£ä»·
>Codis ç»™ Redis å¸¦æ¥äº†æ‰©å®¹çš„åŒæ—¶ï¼Œä¹ŸæŸå¤±äº†å…¶å®ƒä¸€äº›ç‰¹æ€§ã€‚å› ä¸º Codis ä¸­æ‰€æœ‰çš„ keyåˆ†æ•£åœ¨ä¸åŒçš„ Redis å®ä¾‹ä¸­ï¼Œæ‰€ä»¥äº‹åŠ¡å°±ä¸èƒ½å†æ”¯æŒäº†;
>åŒæ ·ä¸ºäº†æ”¯æŒæ‰©å®¹ï¼Œå•ä¸ª key å¯¹åº”çš„ value ä¸å®œè¿‡å¤§ï¼Œå› ä¸ºé›†ç¾¤çš„è¿ç§»çš„æœ€å°å•ä½æ˜¯keyï¼Œå¯¹äºä¸€ä¸ª hash ç»“æ„ï¼Œå®ƒä¼šä¸€æ¬¡æ€§ä½¿ç”¨ hgetall æ‹‰å–æ‰€æœ‰çš„å†…å®¹ï¼Œ
>ç„¶åä½¿ç”¨ hmset æ”¾ç½®åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¦‚æœ hash å†…éƒ¨çš„ kv å¤ªå¤šï¼Œå¯èƒ½ä¼šå¸¦æ¥è¿ç§»å¡é¡¿ã€‚å®˜æ–¹å»ºè®®å•ä¸ªé›†åˆç»“æ„çš„æ€»å­—èŠ‚å®¹é‡ä¸è¦è¶…è¿‡ 1Mã€‚
- codisçš„ä¼˜ç‚¹
>Codis åœ¨è®¾è®¡ä¸Šç›¸æ¯” Redis Cluster å®˜æ–¹é›†ç¾¤æ–¹æ¡ˆè¦ç®€å•å¾ˆå¤šï¼Œå› ä¸ºå®ƒå°†åˆ†å¸ƒå¼çš„é—®é¢˜äº¤ç»™äº†ç¬¬ä¸‰æ–¹ zk/etcd å»è´Ÿè´£ï¼Œè‡ªå·±å°±çœå»äº†å¤æ‚çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§
>ä»£ç çš„ç¼–å†™ç»´æŠ¤å·¥ä½œã€‚è€ŒRedis Cluster çš„å†…éƒ¨å®ç°éå¸¸å¤æ‚ï¼Œå®ƒä¸ºäº†å®ç°å»ä¸­å¿ƒåŒ–ï¼Œæ··åˆä½¿ç”¨äº†å¤æ‚çš„ Raft å’ŒGossip åè®®ï¼Œè¿˜æœ‰å¤§é‡çš„éœ€è¦è°ƒä¼˜çš„é…ç½®å‚æ•°ï¼Œ
>å½“é›†ç¾¤å‡ºç°æ•…éšœæ—¶ï¼Œç»´æŠ¤äººå‘˜å¾€å¾€ä¸çŸ¥é“ä»ä½•å¤„ç€æ‰‹ã€‚
- MGETæŒ‡ä»¤çš„æ“ä½œè¿‡ç¨‹
>mget æŒ‡ä»¤ç”¨äºæ‰¹é‡è·å–å¤šä¸ª key çš„å€¼ï¼Œè¿™äº› key å¯èƒ½ä¼šåˆ†å¸ƒåœ¨å¤šä¸ª Redis å®ä¾‹ä¸­ã€‚Codis çš„ç­–ç•¥æ˜¯å°† key æŒ‰ç…§æ‰€åˆ†é…çš„å®ä¾‹æ‰“æ•£åˆ†ç»„ï¼Œ
>ç„¶åä¾æ¬¡å¯¹æ¯ä¸ªå®ä¾‹è°ƒç”¨ mget æ–¹æ³•ï¼Œæœ€åå°†ç»“æœæ±‡æ€»ä¸ºä¸€ä¸ªï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

## é›†ç¾¤ï¼šä¼—å¿—æˆåŸ-cluster
> RedisCluster æ˜¯ Redis çš„äº²å„¿å­ï¼Œå®ƒæ˜¯ Redis ä½œè€…è‡ªå·±æä¾›çš„ Redis é›†ç¾¤åŒ–æ–¹æ¡ˆã€‚ç›¸å¯¹äº Codis çš„ä¸åŒï¼Œå®ƒæ˜¯å»ä¸­å¿ƒåŒ–çš„ã€‚
Redis Cluster å°†æ‰€æœ‰æ•°æ®åˆ’åˆ†ä¸º 16384 çš„ slotsï¼Œå®ƒæ¯” Codis çš„ 1024 ä¸ªæ§½åˆ’åˆ†çš„æ›´ä¸ºç²¾ç»†ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å…¶ä¸­ä¸€éƒ¨åˆ†æ§½ä½ã€‚
>æ§½ä½çš„ä¿¡æ¯å­˜å‚¨äºæ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå®ƒä¸åƒ Codisï¼Œå®ƒä¸éœ€è¦å¦å¤–çš„åˆ†å¸ƒå¼å­˜å‚¨æ¥å­˜å‚¨èŠ‚ç‚¹æ§½ä½ä¿¡æ¯ã€‚
>å½“ Redis Cluster çš„å®¢æˆ·ç«¯æ¥è¿æ¥é›†ç¾¤æ—¶ï¼Œå®ƒä¹Ÿä¼šå¾—åˆ°ä¸€ä»½é›†ç¾¤çš„æ§½ä½é…ç½®ä¿¡æ¯ã€‚è¿™æ ·å½“å®¢æˆ·ç«¯è¦æŸ¥æ‰¾æŸä¸ª key æ—¶ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚
- æ§½ä½å®šä½ç®—æ³•
>Cluster é»˜è®¤ä¼šå¯¹ key å€¼ä½¿ç”¨ crc32 ç®—æ³•è¿›è¡Œ hash å¾—åˆ°ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç„¶åç”¨è¿™ä¸ªæ•´æ•°å€¼å¯¹ 16384 è¿›è¡Œå–æ¨¡æ¥å¾—åˆ°å…·ä½“æ§½ä½ã€‚
- redis clusterä½¿ç”¨gossipåè®®æ¥å¹¿æ’­çŠ¶æ€
>å› ä¸º Redis Cluster æ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºæŸä¸ªèŠ‚ç‚¹å¤±è”äº†å¹¶ä¸ä»£è¡¨æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½è®¤ä¸ºå®ƒå¤±è”äº†ã€‚æ‰€ä»¥é›†ç¾¤è¿˜å¾—ç»è¿‡ä¸€æ¬¡åå•†çš„è¿‡ç¨‹ï¼Œ
>åªæœ‰å½“å¤§å¤šæ•°èŠ‚ç‚¹éƒ½è®¤å®šäº†æŸä¸ªèŠ‚ç‚¹å¤±è”äº†ï¼Œé›†ç¾¤æ‰è®¤ä¸ºè¯¥èŠ‚ç‚¹éœ€è¦è¿›è¡Œä¸»ä»åˆ‡æ¢æ¥å®¹é”™ã€‚
>Redis é›†ç¾¤èŠ‚ç‚¹é‡‡ç”¨ Gossip åè®®æ¥å¹¿æ’­è‡ªå·±çš„çŠ¶æ€ä»¥åŠè‡ªå·±å¯¹æ•´ä¸ªé›†ç¾¤è®¤çŸ¥çš„æ”¹å˜ã€‚æ¯”å¦‚ä¸€ä¸ªèŠ‚ç‚¹å‘ç°æŸä¸ªèŠ‚ç‚¹å¤±è”äº† (PFail)ï¼Œå®ƒ
>ä¼šå°†è¿™æ¡ä¿¡æ¯å‘æ•´ä¸ªé›†ç¾¤å¹¿æ’­ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¹Ÿå°±å¯ä»¥æ”¶åˆ°è¿™ç‚¹å¤±è”ä¿¡æ¯ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°äº†æŸä¸ªèŠ‚ç‚¹å¤±è”çš„æ•°é‡ (PFail Count) å·²ç»è¾¾åˆ°
>äº†é›†ç¾¤çš„å¤§å¤šæ•°ï¼Œå°±å¯ä»¥æ ‡è®°è¯¥èŠ‚ç‚¹ä¸ºç¡®å®šä¸‹çº¿çŠ¶æ€ (Fail)ï¼Œç„¶åå‘æ•´ä¸ªé›†ç¾¤å¹¿æ’­ï¼Œå¼ºè¿«å…¶å®ƒèŠ‚ç‚¹ä¹Ÿæ¥æ”¶è¯¥èŠ‚ç‚¹å·²ç»ä¸‹çº¿çš„äº‹å®ï¼Œå¹¶ç«‹å³å¯¹è¯¥å¤±è”èŠ‚ç‚¹è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚







